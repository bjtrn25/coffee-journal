<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚òï Coffee Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --navy:#052D57;
  --navy-80:rgba(5,45,87,.8);
  --navy-10:rgba(5,45,87,.08);
  --navy-05:rgba(5,45,87,.04);
  --yellow:#FFBD00;
  --yellow-20:rgba(255,189,0,.18);
  --yellow-10:rgba(255,189,0,.1);
  --white:#ffffff;
  --bg:#F4F6FA;
  --surface:#ffffff;
  --border:rgba(5,45,87,.12);
  --border-strong:rgba(5,45,87,.22);
  --text:var(--navy);
  --text-muted:rgba(5,45,87,.5);
  --danger:#D93025;
  --green:#1A7A4A;
  --radius:10px;
  --radius-sm:6px;
  --shadow:0 1px 3px rgba(5,45,87,.08),0 4px 16px rgba(5,45,87,.06);
  --shadow-md:0 4px 20px rgba(5,45,87,.12);
  /* ÁÑôÁÖéÂ∫¶„Ç´„É©„Éº */
  --roast-light:#D9F7A2;
  --roast-cinnamon:#F6DE8B;
  --roast-medium:#E8C36A;
  --roast-high:#A95522;
  --roast-city:#8B4A2A;
  --roast-fullcity:#5B2D1A;
  --text-dark:#17301A;
  --text-light:#F6F1EA;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;font-size:14px;line-height:1.6;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{background:var(--navy);color:var(--white);padding:0 0;display:flex;flex-direction:column;}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;gap:12px;}
.header-logo{display:flex;align-items:center;gap:10px;}
.header-logo-mark{width:32px;height:32px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.header-title{font-size:18px;font-weight:700;letter-spacing:.04em;color:var(--white);}
.header-title span{color:var(--yellow);}
.header-user-row{display:flex;align-items:center;gap:8px;}
.user-label{font-size:11px;font-weight:300;color:rgba(255,255,255,.5);letter-spacing:.05em;}
.user-name-display{font-size:14px;font-weight:500;color:var(--white);}
.user-switch-btn{font-family:'Noto Sans JP',sans-serif;font-size:11px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--white);padding:3px 10px;cursor:pointer;border-radius:20px;transition:background .2s;font-weight:400;}
.user-switch-btn:hover{background:rgba(255,255,255,.2);}
.cloud-status{font-size:11px;display:flex;align-items:center;gap:5px;color:rgba(255,255,255,.55);}
.status-dot{width:6px;height:6px;border-radius:50%;background:#e74c3c;flex-shrink:0;}
.status-dot.ok{background:#2ecc71;}
.status-dot.syncing{background:var(--yellow);animation:pulse .8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
.nav-tabs{background:var(--navy);display:flex;padding:0 20px;border-top:1px solid rgba(255,255,255,.1);gap:4px;}
.nav-tab{font-family:'Noto Sans JP',sans-serif;font-size:13px;font-weight:400;padding:12px 18px;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;color:rgba(255,255,255,.5);transition:all .2s;margin-bottom:-1px;letter-spacing:.02em;}
.nav-tab:hover{color:rgba(255,255,255,.85);}
.nav-tab.active{color:var(--yellow);border-bottom-color:var(--yellow);font-weight:500;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;}.page.active{display:block;}
.layout{max-width:760px;margin:0 auto;padding:28px 20px 80px;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(5,45,87,.55);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.modal-overlay.hidden{display:none;}
.modal{background:var(--surface);border-radius:var(--radius);padding:28px 32px;width:min(440px,92vw);animation:slideUp .2s;box-shadow:var(--shadow-md);}
@keyframes slideUp{from{transform:translateY(12px);opacity:0}to{transform:none;opacity:1}}
.modal h2{font-size:18px;font-weight:700;margin-bottom:4px;color:var(--navy);}
.modal p{font-size:13px;color:var(--text-muted);margin-bottom:18px;}
.modal-close{float:right;background:none;border:none;font-size:20px;color:var(--text-muted);cursor:pointer;margin-top:-4px;}
.user-list{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
.user-chip{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;cursor:pointer;transition:all .15s;font-size:14px;background:var(--surface);}
.user-chip:hover{border-color:var(--navy);background:var(--navy-05);}
.user-chip.selected{border-color:var(--navy);background:var(--navy-10);font-weight:500;}
.user-chip-del{background:none;border:none;color:var(--border-strong);cursor:pointer;font-size:16px;padding:2px 4px;transition:color .2s;line-height:1;}
.user-chip-del:hover{color:var(--danger);}
.modal-divider{border:none;border-top:1px solid var(--border);margin:14px 0;}
.new-user-row{display:flex;gap:8px;}
.new-user-row input{flex:1;font-family:'Noto Sans JP',sans-serif;font-size:14px;color:var(--text);background:transparent;border:none;border-bottom:1.5px solid var(--border);padding:5px 0;outline:none;transition:border-color .2s;}
.new-user-row input:focus{border-bottom-color:var(--navy);}
.confirm-modal{background:var(--surface);border-radius:var(--radius);padding:24px 28px;width:min(320px,88vw);animation:slideUp .15s;box-shadow:var(--shadow-md);}
.confirm-modal p{font-size:15px;color:var(--text);margin-bottom:18px;}
.confirm-btns{display:flex;gap:8px;justify-content:flex-end;}
.btn-danger{font-family:'Noto Sans JP',sans-serif;font-size:13px;background:var(--danger);color:#fff;border:none;padding:8px 20px;cursor:pointer;border-radius:var(--radius-sm);font-weight:500;}
.btn-cancel-sm{font-family:'Noto Sans JP',sans-serif;font-size:13px;background:transparent;color:var(--text-muted);border:1px solid var(--border);padding:8px 14px;cursor:pointer;border-radius:var(--radius-sm);}

/* ‚îÄ‚îÄ SUPABASE BANNER ‚îÄ‚îÄ */
.supabase-banner{background:var(--yellow-10);border:1px solid rgba(255,189,0,.4);border-radius:var(--radius);padding:14px 18px;margin-bottom:20px;font-size:13px;color:var(--navy);line-height:1.6;}
.supabase-banner strong{display:block;margin-bottom:4px;font-weight:600;}
.supabase-config{display:flex;flex-direction:column;gap:7px;margin-top:10px;}
.supabase-config input{font-family:monospace;font-size:12px;color:var(--text);background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;outline:none;width:100%;}
.save-config-btn{font-family:'Noto Sans JP',sans-serif;font-size:13px;background:var(--navy);color:var(--yellow);border:none;padding:7px 16px;cursor:pointer;border-radius:var(--radius-sm);align-self:flex-start;font-weight:500;}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:22px;}
.stat-item{background:var(--surface);border-radius:var(--radius);padding:16px 12px;text-align:center;box-shadow:var(--shadow);cursor:pointer;transition:all .18s;border:2px solid transparent;}
.stat-item:hover{box-shadow:var(--shadow-md);border-color:var(--border-strong);}
.stat-num{font-size:28px;font-weight:700;color:var(--navy);display:block;line-height:1;}
.stat-label{font-size:10px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);display:block;margin-top:4px;}
.stat-item.accent{background:var(--navy);}
.stat-item.accent .stat-num{color:var(--yellow);}
.stat-item.accent .stat-label{color:rgba(255,255,255,.5);}
.stat-item.filter-active{background:var(--navy);border-color:var(--navy);}
.stat-item.filter-active .stat-num{color:var(--yellow);}
.stat-item.filter-active .stat-label{color:rgba(255,255,255,.6);}

/* ‚îÄ‚îÄ FORM / CARD ‚îÄ‚îÄ */
.card{background:var(--surface);border-radius:var(--radius);padding:22px 26px;margin-bottom:24px;box-shadow:var(--shadow);}
.section-label{font-size:11px;font-weight:700;letter-spacing:.12em;color:var(--text-muted);text-transform:uppercase;display:block;margin-bottom:16px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.form-row.three{grid-template-columns:1fr 1fr 1fr;}
.form-row.one{grid-template-columns:1fr;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group.full{grid-column:1/-1;}
label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);}
input[type=text],input[type=date],input[type=datetime-local],input[type=number],select,textarea{
  font-family:'Noto Sans JP',sans-serif;font-size:14px;color:var(--text);
  background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);
  padding:8px 11px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--navy);box-shadow:0 0 0 3px var(--navy-10);}
select{-webkit-appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23052D57' opacity='.4'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;background-color:var(--bg);padding-right:28px;}
select option{background:var(--white);}
textarea{resize:none;height:60px;line-height:1.6;}

/* TEMP TOGGLE */
.toggle-row{display:flex;border:1.5px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;width:fit-content;background:var(--bg);}
.toggle-btn{font-family:'Noto Sans JP',sans-serif;font-size:13px;padding:7px 18px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);transition:all .15s;font-weight:400;}
.toggle-btn.active{background:var(--navy);color:var(--white);font-weight:500;}

/* FLAVOR CHIPS */
.flavor-cat-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;margin-top:2px;}
.flavor-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.flavor-chip{font-family:'Noto Sans JP',sans-serif;font-size:12px;padding:4px 12px;border:1.5px solid var(--border);border-radius:20px;cursor:pointer;color:var(--text-muted);background:var(--bg);transition:all .15s;user-select:none;font-weight:400;}
.flavor-chip:hover{border-color:var(--navy);color:var(--navy);}
.flavor-chip.selected{background:var(--navy);color:var(--white);border-color:var(--navy);font-weight:500;}

/* STARS */
.stars-row{display:flex;gap:4px;padding:4px 0;}
.star{font-size:20px;cursor:pointer;color:var(--border);transition:color .1s,transform .1s;line-height:1;}
.star.active,.star:hover{color:var(--yellow);transform:scale(1.1);}

/* BUTTONS */
.btn-primary{font-family:'Noto Sans JP',sans-serif;font-size:13px;font-weight:600;background:var(--navy);color:var(--white);border:none;padding:9px 22px;cursor:pointer;transition:all .2s;border-radius:var(--radius-sm);}
.btn-primary:hover{background:#0a3d6e;}
.add-btn{display:flex;align-items:center;gap:8px;background:var(--navy);color:var(--yellow);border:none;font-family:'Noto Sans JP',sans-serif;font-size:14px;font-weight:700;padding:10px 26px;cursor:pointer;transition:all .2s;border-radius:var(--radius-sm);letter-spacing:.02em;}
.add-btn:hover{background:#0a3d6e;transform:translateY(-1px);box-shadow:0 4px 12px rgba(5,45,87,.25);}
.cancel-btn{font-family:'Noto Sans JP',sans-serif;font-size:13px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;padding:10px 0;font-weight:400;}
.cancel-btn:hover{color:var(--text);}
.form-actions{display:flex;gap:12px;margin-top:18px;align-items:center;}

/* ‚îÄ‚îÄ JOURNAL ENTRIES ‚îÄ‚îÄ */
.journal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.journal-title{font-size:16px;font-weight:700;color:var(--navy);}
.entry-count{font-size:12px;color:var(--text-muted);font-weight:400;}
.date-group{margin-bottom:22px;}
.date-label{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.date-label span{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);white-space:nowrap;}
.date-label::after{content:'';flex:1;height:1px;background:var(--border);}
.entry{display:flex;gap:12px;background:var(--surface);border-radius:var(--radius);margin-bottom:8px;padding:14px 16px;animation:fadeIn .25s ease;position:relative;box-shadow:var(--shadow);transition:box-shadow .2s;}
.entry:hover{box-shadow:var(--shadow-md);}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.bullet{flex-shrink:0;width:32px;height:32px;background:var(--navy-10);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;margin-top:1px;}
.entry-body{flex:1;min-width:0;padding-right:78px;}
.entry-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:5px;}
.entry-name{font-size:15px;font-weight:700;color:var(--navy);}
.entry-time{font-size:11px;color:var(--text-muted);flex-shrink:0;background:var(--bg);padding:2px 8px;border-radius:20px;}
.entry-meta{display:flex;align-items:center;gap:5px;margin-bottom:4px;flex-wrap:wrap;}
.tag{font-size:10px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;padding:2px 8px;border-radius:20px;}
.tag.temp-tag{color:var(--navy);background:var(--navy-10);}
.tag.process{color:#1a5a8a;background:rgba(26,90,138,.1);}
.tag.roast-tag{color:var(--text-dark);background:var(--roast-medium);}
.tag.roast-tag[data-roast="„É©„Ç§„Éà"]{background:var(--roast-light);color:var(--text-dark);}
.tag.roast-tag[data-roast="„Ç∑„Éä„É¢„É≥"]{background:var(--roast-cinnamon);color:var(--text-dark);}
.tag.roast-tag[data-roast="„Éü„Éá„Ç£„Ç¢„É†"]{background:var(--roast-medium);color:var(--text-dark);}
.tag.roast-tag[data-roast="„Éè„Ç§"]{background:var(--roast-high);color:var(--text-light);}
.tag.roast-tag[data-roast="„Ç∑„ÉÜ„Ç£"]{background:var(--roast-city);color:var(--text-light);}
.tag.roast-tag[data-roast="„Éï„É´„Ç∑„ÉÜ„Ç£"]{background:var(--roast-fullcity);color:var(--text-light);}
.tag.roast-tag[data-roast="„Éï„É¨„É≥„ÉÅ"]{background:#3a1a0a;color:var(--text-light);}
.tag.roast-tag[data-roast="„Ç§„Çø„É™„Ç¢„É≥"]{background:#1e0e06;color:var(--text-light);}
.tag.flavor{color:var(--green);background:rgba(26,122,74,.1);}
.tag.variety{color:#5a3a8a;background:rgba(90,58,138,.1);}
.entry-rating{color:var(--yellow);font-size:13px;letter-spacing:-.5px;}
.entry-note{font-size:13px;color:var(--text-muted);line-height:1.55;margin-top:3px;}
.entry-detail{font-size:11px;color:var(--text-muted);margin-top:3px;font-weight:400;}
.entry-detail span{color:var(--navy);font-weight:500;}
.entry-actions{position:absolute;right:12px;top:14px;display:flex;gap:2px;}
.icon-btn{background:none;border:none;cursor:pointer;color:var(--border-strong);font-size:14px;padding:4px 5px;transition:color .2s;line-height:1;border-radius:4px;}
.icon-btn:hover{color:var(--navy);background:var(--navy-05);}
.icon-btn.del:hover{color:var(--danger);background:rgba(217,48,37,.07);}
.edit-form{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:16px 18px;margin-top:10px;}
.empty{text-align:center;padding:52px 0;color:var(--text-muted);font-size:14px;}
.empty-icon{font-size:36px;margin-bottom:10px;opacity:.35;}

/* ‚îÄ‚îÄ MONTHLY ARCHIVE ‚îÄ‚îÄ */
.month-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;position:relative;}
.month-display{font-size:20px;font-weight:700;color:var(--navy);cursor:pointer;padding:6px 14px;border-radius:var(--radius);transition:background .15s;user-select:none;display:flex;align-items:center;gap:8px;}
.month-display:hover{background:var(--navy-05);}
.month-display-caret{font-size:12px;color:var(--text-muted);transition:transform .2s;}
.month-display.open .month-display-caret{transform:rotate(180deg);}
.month-btn{background:var(--surface);border:1.5px solid var(--border);color:var(--text-muted);font-size:18px;width:36px;height:36px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);}
.month-btn:hover{border-color:var(--navy);color:var(--navy);}
/* „Ç´„É¨„É≥„ÉÄ„Éº„Éî„ÉÉ„Ç´„Éº */
.month-picker{position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-md);z-index:200;min-width:300px;padding:16px;display:none;}
.month-picker.open{display:block;}
.month-picker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.month-picker-year{font-size:16px;font-weight:700;color:var(--navy);}
.month-picker-nav{background:none;border:1.5px solid var(--border);color:var(--text-muted);font-size:16px;width:30px;height:30px;cursor:pointer;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;transition:all .15s;}
.month-picker-nav:hover{border-color:var(--navy);color:var(--navy);}
.month-picker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.month-picker-cell{padding:8px 4px;text-align:center;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;font-weight:500;color:var(--text-muted);border:1.5px solid transparent;transition:all .15s;position:relative;}
.month-picker-cell:hover{background:var(--navy-05);border-color:var(--border);color:var(--navy);}
.month-picker-cell.has-entries{color:var(--navy);font-weight:700;}
.month-picker-cell.has-entries::after{content:attr(data-count);position:absolute;top:2px;right:4px;font-size:9px;font-weight:600;color:var(--yellow);background:var(--navy);border-radius:20px;padding:0 4px;line-height:16px;min-width:16px;}
.month-picker-cell.selected{background:var(--navy);color:var(--white);border-color:var(--navy);}
.month-picker-cell.selected::after{background:var(--yellow);color:var(--navy);}
.month-picker-cell.current-month{border-color:var(--yellow);}
.month-picker-cell.future{opacity:.35;pointer-events:none;}
.month-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
.month-stat{background:var(--surface);border-radius:var(--radius);text-align:center;padding:14px 8px;box-shadow:var(--shadow);}
.month-stat-num{font-size:22px;font-weight:700;color:var(--navy);display:block;line-height:1;}
.month-stat-label{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);display:block;margin-top:3px;}
.month-stat[style*='cursor']{transition:all .18s;border:2px solid transparent;}

/* ‚îÄ‚îÄ MONTHLY LOG CALENDAR ‚îÄ‚îÄ */
.monthly-log{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 12px 10px;margin-bottom:14px;}
.monthly-log-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.monthly-log-title{font-size:11px;font-weight:700;color:var(--navy-50);letter-spacing:.08em;text-transform:uppercase;}
.monthly-log-legend{display:flex;gap:10px;}
.monthly-log-legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted);}
.monthly-log-legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;}
.monthly-log-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.mlg-dow{text-align:center;font-size:9px;font-weight:700;color:var(--text-muted);letter-spacing:.06em;padding-bottom:4px;}
.mlg-dow.sun{color:#c0392b;}
.mlg-dow.sat{color:#2980b9;}
.mlg-cell{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:6px;position:relative;cursor:default;transition:background .15s;min-width:0;}
.mlg-cell.has-entry{cursor:pointer;}
.mlg-cell.has-entry:hover{background:rgba(5,45,87,.06);}
.mlg-cell.today .mlg-date{border:2px solid var(--yellow);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;}
.mlg-cell.empty{pointer-events:none;}
.mlg-date{font-size:11px;font-weight:500;color:var(--text-muted);line-height:1;}
.mlg-cell.has-entry .mlg-date{color:var(--navy);font-weight:700;}
.mlg-cell.sun .mlg-date{color:#c0392b;}
.mlg-cell.sat .mlg-date{color:#2980b9;}
.mlg-dots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;justify-content:center;max-width:28px;}
.mlg-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.mlg-dot.hot{background:var(--navy);}
.mlg-dot.iced{background:#4A90D9;}
.mlg-count{font-size:8px;font-weight:700;color:var(--navy);margin-top:1px;line-height:1;}
.month-stat[style*='cursor']:hover{box-shadow:var(--shadow-md);border-color:var(--border-strong);}
.month-stat.af-active{background:var(--navy);border-color:var(--navy) !important;}
.month-stat.af-active .month-stat-num{color:var(--yellow);}
.month-stat.af-active .month-stat-label{color:rgba(255,255,255,.6);}
.month-flavor-bar{background:var(--surface);border-radius:var(--radius);padding:18px 20px;margin-bottom:20px;box-shadow:var(--shadow);}
.month-flavor-title{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;}
.flavor-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.flavor-bar-label{font-size:13px;color:var(--text);width:110px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:400;}
.flavor-bar-track{flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;}
.flavor-bar-fill{height:100%;background:var(--yellow);border-radius:3px;transition:width .5s cubic-bezier(.4,0,.2,1);}
.flavor-bar-count{font-size:12px;color:var(--text-muted);width:20px;text-align:right;flex-shrink:0;font-weight:500;}
.month-entry-row{cursor:pointer;transition:box-shadow .15s;}
.month-entry-row:hover{box-shadow:var(--shadow-md);}

/* ‚îÄ‚îÄ BEAN DATABASE ‚îÄ‚îÄ */
.bean-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-bottom:24px;}
.bean-card{background:var(--surface);border-radius:var(--radius);padding:18px 20px;position:relative;transition:box-shadow .2s;box-shadow:var(--shadow);}
.bean-card:hover{box-shadow:var(--shadow-md);}
.bean-card-name{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:7px;}
.bean-card-meta{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;}
.bean-card-note{font-size:12px;color:var(--text-muted);line-height:1.55;}
.bean-card-actions{position:absolute;top:14px;right:14px;display:flex;gap:2px;}
.bean-card-stat{font-size:11px;color:var(--text-muted);margin-top:9px;padding-top:9px;border-top:1px solid var(--border);font-weight:400;}
.bean-card-stat span{color:var(--navy);font-weight:600;}
/* Ë±ÜË©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
.bean-detail-overlay{position:fixed;inset:0;background:rgba(5,45,87,.55);z-index:600;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.bean-detail-overlay.hidden{display:none;}
.bean-detail-modal{background:var(--surface);border-radius:var(--radius);padding:28px 28px 24px;max-width:540px;width:calc(100% - 32px);max-height:88vh;overflow-y:auto;position:relative;box-shadow:var(--shadow-md);}
.bean-detail-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;gap:12px;}
.bean-detail-name{font-size:20px;font-weight:700;color:var(--navy);line-height:1.3;}
.bean-detail-section{margin-bottom:14px;}
.bean-detail-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;}
.bean-detail-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.bean-detail-info{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:14px;}
.bean-detail-info-item{}
.bean-detail-info-key{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);display:block;}
.bean-detail-info-val{font-size:14px;font-weight:500;color:var(--navy);}
.bean-detail-note{font-size:13px;color:var(--text-muted);line-height:1.6;background:var(--bg);border-radius:var(--radius-sm);padding:12px 14px;}
.bean-detail-stat{font-size:12px;color:var(--text-muted);padding-top:12px;border-top:1px solid var(--border);margin-top:4px;}
.bean-detail-stat span{color:var(--navy);font-weight:700;}
.bean-detail-images{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.bean-detail-img{width:80px;height:80px;object-fit:cover;border-radius:var(--radius-sm);cursor:pointer;border:1.5px solid var(--border);transition:border-color .15s;}
.bean-detail-img:hover{border-color:var(--navy);}
.bean-detail-actions{display:flex;gap:8px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border);}
.bean-detail-btn{font-family:'Noto Sans JP',sans-serif;font-size:13px;padding:8px 18px;border-radius:var(--radius-sm);cursor:pointer;font-weight:500;transition:all .15s;border:1.5px solid var(--border);background:var(--surface);color:var(--text);}
.bean-detail-btn:hover{border-color:var(--navy);color:var(--navy);}
.bean-detail-btn.primary{background:var(--navy);color:var(--white);border-color:var(--navy);}
.bean-detail-btn.primary:hover{background:#0a3d6e;}
.bean-detail-btn.danger{color:var(--danger);border-color:rgba(217,48,37,.3);}
.bean-detail-btn.danger:hover{background:rgba(217,48,37,.06);border-color:var(--danger);}

/* ‚îÄ‚îÄ INSIGHTS PAGE ‚îÄ‚îÄ */
.insight-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:16px;}
.insight-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px;}
.insight-card.full{grid-column:1/-1;}
.insight-card-title{font-size:11px;font-weight:700;color:var(--navy-50);letter-spacing:.08em;text-transform:uppercase;margin-bottom:12px;}
.insight-summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.insight-stat{text-align:center;}
.insight-stat-num{font-size:26px;font-weight:800;color:var(--navy);line-height:1;}
.insight-stat-label{font-size:11px;color:var(--navy-50);margin-top:3px;}
.insight-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.insight-bar-label{font-size:12px;font-weight:600;color:var(--navy);width:90px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.insight-bar-track{flex:1;height:10px;background:var(--border);border-radius:99px;overflow:hidden;}
.insight-bar-fill{height:100%;border-radius:99px;background:var(--navy);transition:width .4s ease;}
.insight-bar-count{font-size:11px;color:var(--navy-50);width:24px;text-align:right;flex-shrink:0;}
.insight-donut-wrap{display:flex;align-items:center;gap:16px;}
.insight-legend{flex:1;}
.insight-legend-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;color:var(--navy);}
.insight-legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.insight-chart-canvas{display:block;}
.insight-empty{text-align:center;color:var(--navy-50);font-size:13px;padding:20px 0;}
.insight-hot-iced{display:flex;height:14px;border-radius:99px;overflow:hidden;margin-bottom:8px;}
.insight-hot-bar{background:var(--navy);transition:width .4s;}
.insight-iced-bar{background:var(--yellow);transition:width .4s;}
.insight-hi-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--navy-50);}
.insight-rating-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.insight-rating-stars{font-size:12px;color:var(--yellow);width:60px;flex-shrink:0;}
.insight-month-canvas{width:100%;}
@media(max-width:480px){.insight-grid{grid-template-columns:1fr;}.insight-card.full{grid-column:1;}.insight-summary-grid{grid-template-columns:1fr 1fr;}}

/* ‚îÄ‚îÄ ENTRY DETAIL MODAL ‚îÄ‚îÄ */
.entry-detail-overlay{position:fixed;inset:0;background:rgba(5,45,87,.55);z-index:600;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.entry-detail-overlay.hidden{display:none;}
.entry-detail-modal{background:var(--surface);border-radius:var(--radius);padding:24px 24px 20px;max-width:540px;width:calc(100% - 32px);max-height:90vh;overflow-y:auto;position:relative;box-shadow:var(--shadow-md);}
.entry-detail-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
.entry-detail-icon{font-size:28px;flex-shrink:0;}
.entry-detail-name{font-size:18px;font-weight:700;color:var(--navy);line-height:1.3;flex:1;}
.entry-detail-time{font-size:12px;color:var(--text-muted);margin-top:3px;}
.entry-detail-section{margin-bottom:14px;}
.entry-detail-section .entry-meta{display:flex;flex-wrap:wrap;gap:5px;}
.entry-detail-note-box{background:var(--bg);border-radius:var(--radius-sm);padding:10px 14px;font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px;}
.entry-detail-images{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
.entry-detail-img{width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;transition:opacity .15s;}
.entry-detail-img:hover{opacity:.85;}
.entry-detail-bean-btn{width:100%;padding:10px;background:rgba(5,45,87,.06);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'Noto Sans JP',sans-serif;font-size:13px;font-weight:600;color:var(--navy);cursor:pointer;transition:all .15s;margin-bottom:12px;text-align:left;}
.entry-detail-bean-btn:hover{background:rgba(5,45,87,.12);border-color:var(--navy);}
.entry-detail-actions{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border);}
.entry-detail-btn{font-family:'Noto Sans JP',sans-serif;font-size:13px;padding:8px 16px;border-radius:var(--radius-sm);cursor:pointer;font-weight:500;transition:all .15s;border:1.5px solid var(--border);background:var(--surface);color:var(--text);}
.entry-detail-btn:hover{border-color:var(--navy);color:var(--navy);}
.entry-detail-btn.danger{color:var(--danger);border-color:rgba(217,48,37,.3);}
.entry-detail-btn.danger:hover{background:rgba(217,48,37,.06);border-color:var(--danger);}
.bean-add-btn{display:flex;align-items:center;justify-content:center;gap:8px;border:2px dashed var(--border);padding:22px;cursor:pointer;color:var(--text-muted);font-family:'Noto Sans JP',sans-serif;font-size:13px;background:transparent;width:100%;transition:all .2s;border-radius:var(--radius);font-weight:400;}
.bean-add-btn:hover{border-color:var(--navy);color:var(--navy);background:var(--navy-05);}

/* ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ */
.img-upload-area{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:14px 16px;cursor:pointer;text-align:center;transition:all .2s;margin-bottom:4px;position:relative;background:var(--bg);}
.img-upload-area:hover{border-color:var(--navy);background:var(--navy-05);}
.img-upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.img-upload-label{font-size:13px;color:var(--text-muted);pointer-events:none;font-weight:400;}
.img-upload-label span{color:var(--navy);font-weight:500;}
.img-preview-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.img-thumb-wrap{position:relative;width:72px;height:72px;flex-shrink:0;}
.img-thumb{width:72px;height:72px;object-fit:cover;border-radius:var(--radius-sm);border:2px solid var(--border);cursor:pointer;transition:opacity .2s;}
.img-thumb:hover{opacity:.8;}
.img-thumb-del{position:absolute;top:-6px;right:-6px;width:18px;height:18px;border-radius:50%;background:var(--navy);color:var(--white);border:none;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;line-height:1;}
/* entry images */
.entry-images{display:flex;flex-wrap:wrap;gap:6px;margin-top:9px;}
.entry-img{width:68px;height:68px;object-fit:cover;border-radius:var(--radius-sm);border:2px solid var(--border);cursor:pointer;transition:opacity .2s,transform .15s;}
.entry-img:hover{opacity:.85;transform:scale(1.05);}
/* lightbox */
.lightbox{position:fixed;inset:0;background:rgba(5,45,87,.92);z-index:2000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.lightbox.hidden{display:none;}
.lightbox img{max-width:92vw;max-height:88vh;object-fit:contain;border-radius:var(--radius-sm);}
.lightbox-close{position:fixed;top:18px;right:22px;background:rgba(255,255,255,.12);border:none;color:#fff;font-size:22px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s;}
.lightbox-close:hover{background:rgba(255,255,255,.25);}
.lightbox-nav{position:fixed;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.12);border:none;color:#fff;font-size:26px;width:44px;height:64px;cursor:pointer;transition:background .2s;border-radius:var(--radius-sm);}
.lightbox-nav:hover{background:rgba(255,255,255,.22);}
.lightbox-nav.prev{left:10px;}
.lightbox-nav.next{right:10px;}
.lightbox-counter{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.55);font-size:13px;background:rgba(5,45,87,.5);padding:4px 14px;border-radius:20px;}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
.login-screen{position:fixed;inset:0;background:var(--navy);z-index:9000;display:flex;align-items:center;justify-content:center;}
.login-screen.hidden{display:none;}
.login-box{background:var(--white);border-radius:16px;padding:48px 40px;width:min(380px,90vw);text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.login-logo{width:56px;height:56px;background:var(--navy);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 20px;}
.login-title{font-size:22px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.login-sub{font-size:13px;color:var(--text-muted);margin-bottom:32px;line-height:1.6;}
.login-google-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:13px 20px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--white);cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:14px;font-weight:500;color:var(--navy);transition:all .2s;}
.login-google-btn:hover{background:var(--bg);border-color:var(--navy);box-shadow:0 2px 8px rgba(5,45,87,.1);}
.login-google-btn svg{flex-shrink:0;}
.login-loading{font-size:13px;color:var(--text-muted);margin-top:16px;display:none;}
.logout-btn{font-family:'Noto Sans JP',sans-serif;font-size:11px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:3px 10px;cursor:pointer;border-radius:20px;transition:background .2s;}
.logout-btn:hover{background:rgba(255,255,255,.2);}
.user-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(255,255,255,.3);}

/* ‚îÄ‚îÄ LOGIN / SETUP SCREEN ‚îÄ‚îÄ */
.screen-overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:var(--navy);}
.screen-overlay.hidden{display:none;}
.login-box{width:min(380px,92vw);padding:40px 36px;background:var(--white);border-radius:16px;box-shadow:0 20px 60px rgba(5,45,87,.3);text-align:center;}
.login-logo{width:56px;height:56px;background:var(--navy);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 18px;}
.login-title{font-size:22px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.login-sub{font-size:13px;color:var(--text-muted);margin-bottom:28px;line-height:1.5;}
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px 20px;border:1.5px solid var(--border);border-radius:8px;background:var(--white);cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:14px;font-weight:500;color:var(--navy);transition:all .2s;}
.google-btn:hover{background:var(--bg);border-color:var(--navy);}
.google-btn svg{flex-shrink:0;}
.setup-box{width:min(420px,92vw);padding:36px;background:var(--white);border-radius:16px;box-shadow:0 20px 60px rgba(5,45,87,.3);}
.setup-box h2{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.setup-box p{font-size:13px;color:var(--text-muted);margin-bottom:20px;line-height:1.6;}
.setup-field{margin-bottom:12px;}
.setup-field label{display:block;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:5px;}
.setup-field input{width:100%;font-family:monospace;font-size:12px;color:var(--text);background:var(--bg);border:1.5px solid var(--border);border-radius:6px;padding:8px 10px;outline:none;}
.setup-field input:focus{border-color:var(--navy);}
.setup-btn{width:100%;margin-top:6px;font-family:'Noto Sans JP',sans-serif;font-size:14px;font-weight:700;background:var(--navy);color:var(--yellow);border:none;padding:12px;border-radius:8px;cursor:pointer;}
.loading-screen{position:fixed;inset:0;z-index:999;background:var(--navy);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-screen.hidden{display:none;}
.loading-spinner{width:36px;height:36px;border:3px solid rgba(255,189,0,.3);border-top-color:var(--yellow);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:rgba(255,255,255,.6);font-size:13px;}

@media(max-width:540px){
  .form-row,.form-row.three{grid-template-columns:1fr;}
  .card{padding:16px 14px;}
  .stats,.month-summary{grid-template-columns:repeat(2,1fr);}
  .bean-grid{grid-template-columns:1fr;}
  .nav-tab{padding:10px 12px;font-size:12px;}
  .header-top{padding:12px 16px;}
  .layout{padding:20px 14px 70px;}
}

/* -- SHARE CARD MODAL -- */
.share-modal-overlay{position:fixed;inset:0;background:rgba(5,45,87,.7);z-index:3000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn .2s;}
.share-modal-overlay.hidden{display:none;}
.share-modal{background:var(--surface);border-radius:16px;padding:28px 28px 24px;width:min(480px,94vw);box-shadow:0 20px 60px rgba(5,45,87,.3);animation:slideUp .2s;}
.share-modal-title{font-size:16px;font-weight:700;color:var(--navy);margin-bottom:4px;}
.share-modal-sub{font-size:12px;color:var(--text-muted);margin-bottom:18px;}
.share-canvas-wrap{border-radius:10px;overflow:hidden;box-shadow:0 4px 20px rgba(5,45,87,.15);margin-bottom:18px;line-height:0;}
.share-canvas-wrap canvas{width:100%;height:auto;display:block;}
.share-actions{display:flex;gap:10px;flex-wrap:wrap;}
.share-btn{flex:1;min-width:120px;font-family:'Noto Sans JP',sans-serif;font-size:13px;font-weight:600;padding:10px 16px;border-radius:8px;cursor:pointer;border:none;display:flex;align-items:center;justify-content:center;gap:7px;transition:all .2s;}
.share-btn.primary{background:var(--navy);color:var(--yellow);}
.share-btn.primary:hover{background:#0a3d6e;}
.share-btn.secondary{background:var(--bg);color:var(--navy);border:1.5px solid var(--border);}
.share-btn.secondary:hover{border-color:var(--navy);background:var(--navy-05);}
.share-btn.close-btn{background:transparent;color:var(--text-muted);border:1.5px solid var(--border);flex:0 0 auto;min-width:auto;padding:10px 14px;}
.share-btn.close-btn:hover{color:var(--navy);border-color:var(--navy);}
.icon-btn.share:hover{color:#1a7a4a;background:rgba(26,122,74,.07);}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
</div>

<!-- SETUP SCREEN (ÂàùÂõû„ÅÆ„Åø) -->
<div class="screen-overlay hidden" id="setupScreen">
  <div class="setup-box">
    <div style="font-size:28px;margin-bottom:12px;">‚òï</div>
    <h2>Supabase „ÅÆË®≠ÂÆö</h2>
    <p>ÊúÄÂàù„Å´1Âõû„Å†„ÅëË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ<br>Supabase „ÅÆ Project URL „Å® anon key „ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    <div class="setup-field">
      <label>Project URL</label>
      <input type="text" id="setup-url" placeholder="https://xxxx.supabase.co">
    </div>
    <div class="setup-field">
      <label>Anon Key</label>
      <input type="text" id="setup-key" placeholder="eyJhbGci...">
    </div>
    <button class="setup-btn" onclick="saveSetup()">Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Å¶„É≠„Ç∞„Ç§„É≥„Å∏</button>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div class="screen-overlay hidden" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">‚òï</div>
    <div class="login-title">Coffee Journal</div>
    <div class="login-sub">„ÅÇ„Å™„Åü„ÅÆ„Ç≥„Éº„Éí„ÉºË®òÈå≤„Çí<br>„Å©„Åì„Åã„Çâ„Åß„ÇÇÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</div>
    <button class="google-btn" onclick="signInWithGoogle()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 01-7.18-2.54H1.83v2.07A8 8 0 008.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 010-3.04V5.41H1.83a8 8 0 000 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 001.83 5.4L4.5 7.49a4.77 4.77 0 014.48-3.3z"/></svg>
      Google „Åß„É≠„Ç∞„Ç§„É≥
    </button>
  </div>
</div>

<!-- MODALS -->
<!-- USER MODAL removed - using Google Auth -->
<div class="modal-overlay hidden" id="userModal" style="display:none"></div>

<div class="modal-overlay hidden" id="confirmModal">
  <div class="confirm-modal">
    <p id="confirmMsg"></p>
    <div class="confirm-btns">
      <button class="btn-cancel-sm" onclick="confirmResolve(false)">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn-danger" onclick="confirmResolve(true)">ÂâäÈô§„Åô„Çã</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
  <button class="lightbox-nav prev" onclick="event.stopPropagation();lightboxStep(-1)">‚Äπ</button>
  <img id="lightboxImg" src="" alt="">
  <button class="lightbox-nav next" onclick="event.stopPropagation();lightboxStep(1)">‚Ä∫</button>
  <div class="lightbox-counter" id="lightboxCounter"></div>
</div>

<!-- SHARE CARD MODAL -->
<div class="share-modal-overlay hidden" id="shareModal" onclick="if(event.target===this)closeShareModal()">
  <div class="share-modal">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px;">
      <div>
        <div class="share-modal-title">&#x2615; „ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà„ÇíÂÖ±Êúâ</div>
        <div class="share-modal-sub">„Ç´„Éº„ÉâÁîªÂÉè„Çí‰øùÂ≠ò„ÉªÂÖ±Êúâ„Åß„Åç„Åæ„Åô</div>
      </div>
      <button class="share-btn close-btn" onclick="closeShareModal()" style="margin-top:-4px;">&#x2715;</button>
    </div>
    <div style="position:relative;">
      <div class="share-canvas-wrap" id="shareCanvasWrap" onclick="expandShareCard()" style="cursor:zoom-in;" title="„Çø„ÉÉ„Éó„ÅßÊã°Â§ß">
        <canvas id="shareCanvas"></canvas>
      </div>
      <div style="position:absolute;bottom:8px;right:10px;background:rgba(5,45,87,.55);color:rgba(255,255,255,.75);font-size:11px;padding:3px 9px;border-radius:20px;pointer-events:none;backdrop-filter:blur(2px);">&#x1F50D; „Çø„ÉÉ„Éó„ÅßÊã°Â§ß</div>
    </div>
    <div class="share-actions">
      <button class="share-btn primary" onclick="downloadShareCard()">&#x2B07; ÁîªÂÉè„Çí‰øùÂ≠ò</button>
      <button class="share-btn secondary" id="shareNativeBtn" onclick="nativeShare()" style="display:none;">&#x1F4E4; ÂÖ±Êúâ„Åô„Çã</button>
    </div>
  </div>
</div>

<!-- SHARE CARD EXPAND (full-screen view) -->
<div id="shareExpandOverlay" style="display:none;position:fixed;inset:0;background:rgba(5,45,87,.92);z-index:4000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);" onclick="closeExpandCard()">
  <img id="shareExpandImg" src="" alt="" style="max-width:96vw;max-height:92vh;object-fit:contain;border-radius:12px;box-shadow:0 8px 48px rgba(0,0,0,.5);">
  <button onclick="closeExpandCard()" style="position:fixed;top:16px;right:20px;background:rgba(255,255,255,.15);border:none;color:#fff;font-size:22px;width:42px;height:42px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#x2715;</button>
</div>

<!-- BEAN MODAL -->
<div class="modal-overlay hidden" id="beanModal">
  <div class="modal" style="max-height:90vh;overflow-y:auto;">
    <button class="modal-close" onclick="closeBeanModal()">√ó</button>
    <h2 id="beanModalTitle">Ë±Ü„ÇíÁôªÈå≤</h2>
    <p style="margin-bottom:16px;">ÂìÅÁ®Æ„ÉªÁî£Âú∞„Å™„Å©„ÅÆË©≥Á¥∞„ÇíË®òÈå≤„Åó„Åæ„Åô</p>
    <!-- ÂêçÂâç + ÁîüÁî£ÂõΩ -->
    <div class="form-row">
      <div class="form-group"><label>Ë±Ü„ÅÆÂêçÂâç *</label><input type="text" id="bm-name" placeholder="‰æã: „Ç§„É´„Ç¨„ÉÅ„Çß„Éï„Çß G1"></div>
      <div class="form-group"><label>ÁîüÁî£ÂõΩ</label>
        <select id="bm-country">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„Ç®„ÉÅ„Ç™„Éî„Ç¢</option><option>„Ç±„Éã„Ç¢</option><option>„Ç≥„É≠„É≥„Éì„Ç¢</option>
          <option>„Éñ„É©„Ç∏„É´</option><option>„Ç∞„Ç¢„ÉÜ„Éû„É©</option><option>„Éë„Éä„Éû</option>
          <option>„Ç≥„Çπ„Çø„É™„Ç´</option><option>„Ç®„É´„Çµ„É´„Éê„Éâ„É´</option><option>„Éõ„É≥„Ç∏„É•„É©„Çπ</option>
          <option>„Éö„É´„Éº</option><option>„Éú„É™„Éì„Ç¢</option><option>„Ç§„Ç®„É°„É≥</option>
          <option>„Ç§„É≥„Éâ„Éç„Ç∑„Ç¢</option><option>„Éô„Éà„Éä„É†</option><option>„Çø„Ç§</option>
          <option>„Éü„É£„É≥„Éû„Éº</option><option>„Ç§„É≥„Éâ</option><option>„Çø„É≥„Ç∂„Éã„Ç¢</option>
          <option>„Ç¶„Ç¨„É≥„ÉÄ</option><option>„É´„ÉØ„É≥„ÉÄ</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
    </div>
    <!-- ÂìÅÁ®Æ + Âú∞Âüü -->
    <div class="form-row">
      <div class="form-group"><label>ÂìÅÁ®Æ (Variety)</label>
        <select id="bm-variety">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„Ç≤„Ç§„Ç∑„É£</option><option>„Éñ„É´„Éú„É≥</option><option>„ÉÜ„Ç£„Éî„Ç´</option>
          <option>„Ç´„Éà„Ç•„Éº„É©</option><option>„Ç´„Éà„Ç•„Ç¢„Ç§</option><option>„Éë„Ç´„Éû„É©</option>
          <option>SL28</option><option>SL34</option><option>„É†„É≥„Éâ„Éé„Éº„Éú</option>
          <option>„Éû„É©„Ç¥„Ç∏„ÉÉ„Éö</option><option>„Ç∏„É£„Éê</option><option>„Ç±„É≥„Éà</option>
          <option>S795</option><option>„É≠„Éº„É™„Éä</option><option>„Éì„Ç∏„É£„Çµ„É´„ÉÅ</option>
          <option>„Éè„É©„Éº</option><option>„Ç∏„É≥„Éû</option><option>74110</option>
          <option>74112</option><option>„É´„Ç§„É´11</option><option>„Éê„ÉÜ„Ç£„Ç¢„É≥</option>
          <option>„Ç≥„É≠„É≥„Éì„Ç¢</option><option>„ÇØ„É™„Ç™„Éº„Ç∏„Éß</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
      <div class="form-group"><label>Âú∞Âüü / Ëæ≤Âúí</label><input type="text" id="bm-region" placeholder="‰æã: „Ç§„É´„Ç¨„ÉÅ„Çß„Éï„Çß / Worka"></div>
    </div>
    <!-- Ê®ôÈ´ò + „Éó„É≠„Çª„Çπ -->
    <div class="form-row">
      <div class="form-group"><label>Ê®ôÈ´ò (masl)</label><input type="number" id="bm-altitude" placeholder="‰æã: 1900"></div>
      <div class="form-group"><label>„Éó„É≠„Çª„Çπ</label>
        <select id="bm-process">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„Ç¶„Ç©„ÉÉ„Ç∑„É•„Éâ</option><option>„Éä„ÉÅ„É•„É©„É´</option>
          <option>„Éè„Éã„Éº / „Éë„É´„Éó„Éâ„Éä„ÉÅ„É•„É©„É´</option><option>„Ç¢„Éä„Ç®„É≠„Éì„ÉÉ„ÇØ</option>
          <option>„Ç¶„Çß„ÉÉ„Éà„Éè„É´</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
    </div>
    <!-- ÁÑôÁÖéÂ∫¶ + ÁÑôÁÖéÊó• -->
    <div class="form-row">
      <div class="form-group"><label>ÁÑôÁÖéÂ∫¶</label>
        <select id="bm-roast">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„É©„Ç§„Éà</option><option>„Ç∑„Éä„É¢„É≥</option><option>„Éü„Éá„Ç£„Ç¢„É†</option>
          <option>„Éè„Ç§</option><option>„Ç∑„ÉÜ„Ç£</option><option>„Éï„É´„Ç∑„ÉÜ„Ç£</option>
          <option>„Éï„É¨„É≥„ÉÅ</option><option>„Ç§„Çø„É™„Ç¢„É≥</option>
        </select>
      </div>
      <div class="form-group"><label>ÁÑôÁÖéÊó•</label><input type="date" id="bm-roastdate"></div>
    </div>
    <!-- „É≠„Éº„Çπ„Çø„Éº -->
    <div class="form-row one">
      <div class="form-group full"><label>„É≠„Éº„Çπ„Çø„Éº / Ë≥ºÂÖ•ÂÖà</label><input type="text" id="bm-roaster" placeholder="‰æã: Light Up Coffee"></div>
    </div>
    <div class="form-row one">
      <div class="form-group full"><label>„É°„É¢</label><textarea id="bm-note" placeholder="È¶ô„Çä„ÄÅÂ§ñË¶≥„ÄÅË≥ºÂÖ•ÁêÜÁî±„Å™„Å©‚Ä¶"></textarea></div>
    </div>
    <div class="form-actions" style="margin-top:14px;">
      <button class="add-btn" onclick="saveBean()">‰øùÂ≠ò</button>
      <button class="cancel-btn" onclick="closeBeanModal()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
</div>

<!-- BEAN DETAIL MODAL -->
<div class="bean-detail-overlay hidden" id="beanDetailModal" onclick="if(event.target===this)closeBeanDetail()">
  <div class="bean-detail-modal">
    <div class="bean-detail-header">
      <div>
        <div class="bean-detail-name" id="bd-name"></div>
        <div class="bean-detail-row" id="bd-tags" style="margin-top:8px;"></div>
      </div>
      <button class="modal-close" onclick="closeBeanDetail()" style="position:static;flex-shrink:0;">√ó</button>
    </div>
    <div class="bean-detail-info" id="bd-info"></div>
    <div id="bd-note-wrap" style="display:none;margin-bottom:14px;">
      <div class="bean-detail-label">„É°„É¢</div>
      <div class="bean-detail-note" id="bd-note"></div>
    </div>
    <div id="bd-images-wrap" style="display:none;">
      <div class="bean-detail-label">ÁîªÂÉè</div>
      <div class="bean-detail-images" id="bd-images"></div>
    </div>
    <div class="bean-detail-stat" id="bd-stat"></div>
    <div class="bean-detail-actions">
      <button class="bean-detail-btn primary" id="bd-edit-btn" onclick="">‚úé Á∑®ÈõÜ</button>
      <button class="bean-detail-btn danger" id="bd-del-btn" onclick="">‚úï ÂâäÈô§</button>
      <button class="bean-detail-btn" onclick="closeBeanDetail()">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- INSIGHTS PAGE -->
<div class="page" id="page-insights">
  <div class="insight-grid">
    <!-- „Çµ„Éû„É™„Éº -->
    <div class="insight-card full">
      <div class="insight-card-title">üìä „Çµ„Éû„É™„Éº</div>
      <div class="insight-summary-grid">
        <div class="insight-stat"><div class="insight-stat-num" id="ins-total">0</div><div class="insight-stat-label">Á∑èË®òÈå≤Êï∞</div></div>
        <div class="insight-stat"><div class="insight-stat-num" id="ins-avg">‚Äî</div><div class="insight-stat-label">Âπ≥ÂùáË©ï‰æ°</div></div>
        <div class="insight-stat"><div class="insight-stat-num" id="ins-days">‚Äî</div><div class="insight-stat-label">Ë®òÈå≤ÊúüÈñìÔºàÊó•Ôºâ</div></div>
        <div class="insight-stat"><div class="insight-stat-num" id="ins-beans-used">‚Äî</div><div class="insight-stat-label">‰ΩøÁî®Ë±ÜÁ®ÆÈ°û</div></div>
      </div>
      <div style="margin-top:14px;">
        <div class="insight-hot-iced"><div class="insight-hot-bar" id="ins-hot-bar" style="width:50%"></div><div class="insight-iced-bar" id="ins-iced-bar" style="width:50%"></div></div>
        <div class="insight-hi-labels"><span id="ins-hot-label">‚òï „Éõ„ÉÉ„Éà 0</span><span id="ins-iced-label">üßä „Ç¢„Ç§„Çπ 0</span></div>
      </div>
    </div>
    <!-- „Éï„É¨„Éº„Éê„Éº„Éà„ÉÉ„Éó -->
    <div class="insight-card full" id="ins-flavor-card">
      <div class="insight-card-title">üçÉ Â•Ω„Åç„Å™„Éï„É¨„Éº„Éê„Éº Top 10</div>
      <div id="ins-flavors"></div>
    </div>
    <!-- ÁÑôÁÖéÂ∫¶ÂàÜÂ∏É -->
    <div class="insight-card full" id="ins-roast-card">
      <div class="insight-card-title">üî• ÁÑôÁÖéÂ∫¶„ÅÆÂàÜÂ∏É</div>
      <div id="ins-roasts"></div>
    </div>
    <!-- Ë©ï‰æ°ÂàÜÂ∏É -->
    <div class="insight-card">
      <div class="insight-card-title">‚òÖ Ë©ï‰æ°„ÅÆÂàÜÂ∏É</div>
      <div id="ins-ratings"></div>
    </div>
    <!-- „Éó„É≠„Çª„ÇπÂàÜÂ∏É -->
    <div class="insight-card">
      <div class="insight-card-title">‚öôÔ∏è „Éó„É≠„Çª„Çπ</div>
      <div id="ins-processes"></div>
    </div>
    <!-- Â†¥ÊâÄ„É©„É≥„Ç≠„É≥„Ç∞ -->
    <div class="insight-card full" id="ins-place-card">
      <div class="insight-card-title">üìç „Çà„ÅèË®™„Çå„ÇãÂ†¥ÊâÄ Top 8</div>
      <div id="ins-places"></div>
    </div>
    <!-- „ÅäÊ∞ó„Å´ÂÖ•„ÇäË±Ü -->
    <div class="insight-card full" id="ins-bean-card">
      <div class="insight-card-title">üå± „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆË±Ü Top 5</div>
      <div id="ins-beans"></div>
    </div>
    <!-- ÊúàÂà•Êé®Áßª -->
    <div class="insight-card full">
      <div class="insight-card-title">üìÖ ÊúàÂà•Ë®òÈå≤Êï∞„ÅÆÊé®Áßª</div>
      <canvas id="ins-month-chart" class="insight-month-canvas" height="120"></canvas>
    </div>
  </div>
</div>

<!-- ENTRY DETAIL MODAL -->
<div class="entry-detail-overlay hidden" id="entryDetailModal" onclick="if(event.target===this)closeEntryDetail()">
  <div class="entry-detail-modal">
    <div class="entry-detail-header">
      <div class="entry-detail-icon" id="ed-icon">‚òï</div>
      <div style="flex:1;min-width:0;">
        <div class="entry-detail-name" id="ed-name"></div>
        <div class="entry-detail-time" id="ed-time"></div>
      </div>
      <button class="modal-close" onclick="closeEntryDetail()" style="position:static;flex-shrink:0;">√ó</button>
    </div>
    <div class="entry-detail-section">
      <div class="entry-meta" id="ed-tags"></div>
    </div>
    <div class="entry-detail-section" id="ed-flavors-wrap">
      <div class="entry-meta" id="ed-flavors"></div>
    </div>
    <div id="ed-roast-wrap" style="display:none;margin-bottom:10px;">
      <div class="entry-detail" id="ed-roast"></div>
    </div>
    <div id="ed-altitude-wrap" style="display:none;margin-bottom:10px;">
      <div class="entry-detail" id="ed-altitude"></div>
    </div>
    <div id="ed-note-wrap" style="display:none;">
      <div class="entry-detail-note-box" id="ed-note"></div>
    </div>
    <div id="ed-images-wrap" style="display:none;">
      <div class="entry-detail-images" id="ed-images"></div>
    </div>
    <div id="ed-bean-wrap" style="display:none;">
      <button class="entry-detail-bean-btn" id="ed-bean-btn"></button>
    </div>
    <div class="entry-detail-actions">
      <button class="entry-detail-btn" id="ed-share-btn">üì§ ÂÖ±Êúâ</button>
      <button class="entry-detail-btn" id="ed-edit-btn">‚úé Á∑®ÈõÜ</button>
      <button class="entry-detail-btn danger" id="ed-del-btn">‚úï ÂâäÈô§</button>
      <button class="entry-detail-btn" onclick="closeEntryDetail()">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- APP -->
<header class="header">
  <div class="header-top">
    <div class="header-logo">
      <div class="header-logo-mark">‚òï</div>
      <span class="header-title">Coffee <span>Journal</span></span>
    </div>
    <div class="header-user-row">
      <img class="user-avatar" id="userAvatar" src="" alt="" style="display:none">
      <span class="user-name-display" id="userNameDisplay">‚Äî</span>
      <button class="logout-btn" onclick="signOut()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
      <div class="cloud-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Êé•Á∂ö‰∏≠</span>
      </div>
    </div>
  </div>

  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('journal')">‚òï „Ç∏„É£„Éº„Éä„É´</button>
    <button class="nav-tab" onclick="showPage('archive')">üìÖ ÊúàÂà•„Ç¢„Éº„Ç´„Ç§„Éñ</button>
    <button class="nav-tab" onclick="showPage('beans')">üå± Ë±Ü„Éá„Éº„Çø„Éô„Éº„Çπ</button>
    <button class="nav-tab" onclick="showPage('insights')">üìä „Ç§„É≥„Çµ„Ç§„Éà</button>
  </nav>
</header>

<!-- PAGE: JOURNAL -->
<div class="page active" id="page-journal">
<div class="layout">

  <!-- Supabase Êé•Á∂öÊ∏à„ÅøÔºàGoogle Auth‰ΩøÁî®Ôºâ -->

  <div class="stats">
    <div class="stat-item" id="filter-all" onclick="setJournalFilter('all')"><span class="stat-num" id="stat-total">0</span><span class="stat-label">ÂêàË®à</span></div>
    <div class="stat-item accent" id="filter-today" onclick="setJournalFilter('today')"><span class="stat-num" id="stat-today">0</span><span class="stat-label">‰ªäÊó•</span></div>
    <div class="stat-item"><span class="stat-num" id="stat-hot">0</span><span class="stat-label">„Éõ„ÉÉ„Éà</span></div>
    <div class="stat-item"><span class="stat-num" id="stat-iced">0</span><span class="stat-label">„Ç¢„Ç§„Çπ</span></div>
  </div>

  <div class="card">
    <span class="section-label">‚óÜ Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„Éº</span>
    <div class="form-row">
      <div class="form-group"><label>„Ç≥„Éº„Éí„ÉºÂêç</label><input type="text" id="f-name" placeholder="‰æã: „Ç®„ÉÅ„Ç™„Éî„Ç¢ „Ç§„É´„Ç¨„ÉÅ„Çß„Éï„Çß"></div>
      <div class="form-group"><label>Ë±ÜÔºà„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÔºâ</label>
        <select id="f-bean-ref" onchange="autofillFromBean()">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Ê∏©Â∫¶</label>
        <div class="toggle-row">
          <button class="toggle-btn active" id="btn-hot" onclick="setTemp('hot')">‚òï „Éõ„ÉÉ„Éà</button>
          <button class="toggle-btn" id="btn-iced" onclick="setTemp('iced')">üßä „Ç¢„Ç§„Çπ</button>
        </div>
      </div>
      <div class="form-group"><label>È£≤„Çì„Å†Êó•ÊôÇ</label><input type="datetime-local" id="f-datetime"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Â†¥ÊâÄ / Â∫óËàó</label><input type="text" id="f-place" placeholder="‰æã: Blue Bottle Ê∏ãË∞∑"></div>
      <div class="form-group"><label>ÂìÅÁ®Æ (Variety)</label>
        <select id="f-variety">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„Ç≤„Ç§„Ç∑„É£</option><option>„Éñ„É´„Éú„É≥</option><option>„ÉÜ„Ç£„Éî„Ç´</option>
          <option>„Ç´„Éà„Ç•„Éº„É©</option><option>„Ç´„Éà„Ç•„Ç¢„Ç§</option><option>„Éë„Ç´„Éû„É©</option>
          <option>SL28</option><option>SL34</option><option>„É†„É≥„Éâ„Éé„Éº„Éú</option>
          <option>„Éû„É©„Ç¥„Ç∏„ÉÉ„Éö</option><option>„Ç∏„É£„Éê</option><option>„Ç±„É≥„Éà</option>
          <option>S795</option><option>„É≠„Éº„É™„Éä</option><option>„Éì„Ç∏„É£„Çµ„É´„ÉÅ</option>
          <option>„Éè„É©„Éº</option><option>„Ç∏„É≥„Éû</option><option>74110</option>
          <option>74112</option><option>„É´„Ç§„É´11</option><option>„Éê„ÉÜ„Ç£„Ç¢„É≥</option>
          <option>„Ç≥„É≠„É≥„Éì„Ç¢</option><option>„ÇØ„É™„Ç™„Éº„Ç∏„Éß</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
    </div>
    <div class="form-row three">
      <div class="form-group"><label>„Éó„É≠„Çª„Çπ</label>
        <select id="f-process">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„Ç¶„Ç©„ÉÉ„Ç∑„É•„Éâ</option><option>„Éä„ÉÅ„É•„É©„É´</option>
          <option>„Éè„Éã„Éº / „Éë„É´„Éó„Éâ„Éä„ÉÅ„É•„É©„É´</option><option>„Ç¢„Éä„Ç®„É≠„Éì„ÉÉ„ÇØ</option>
          <option>„Ç¶„Çß„ÉÉ„Éà„Éè„É´</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
      <div class="form-group"><label>ÁÑôÁÖéÂ∫¶</label>
        <select id="f-roast-level">
          <option value="">‚Äî Êú™ÈÅ∏Êäû ‚Äî</option>
          <option>„É©„Ç§„Éà</option><option>„Ç∑„Éä„É¢„É≥</option><option>„Éü„Éá„Ç£„Ç¢„É†</option>
          <option>„Éè„Ç§</option><option>„Ç∑„ÉÜ„Ç£</option><option>„Éï„É´„Ç∑„ÉÜ„Ç£</option>
          <option>„Éï„É¨„É≥„ÉÅ</option><option>„Ç§„Çø„É™„Ç¢„É≥</option>
        </select>
      </div>
      <div class="form-group"><label>ÁÑôÁÖéÊó•</label><input type="date" id="f-roast-date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Ê®ôÈ´ò (masl)</label><input type="number" id="f-altitude" placeholder="‰æã: 1900"></div>
      <div class="form-group"><!-- spacer --></div>
    </div>
    <div style="margin-bottom:14px;">
      <label style="display:block;margin-bottom:9px;">„Éï„É¨„Éº„Éê„Éº„Éé„Éº„ÉàÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
      <div id="flavorCategories"></div>
    </div>
    <div class="form-row">
      <div class="form-group full"><label>Ë©ï‰æ°</label>
        <div class="stars-row" id="stars">
          <span class="star" data-v="1">‚òÖ</span><span class="star" data-v="2">‚òÖ</span>
          <span class="star" data-v="3">‚òÖ</span><span class="star" data-v="4">‚òÖ</span>
          <span class="star" data-v="5">‚òÖ</span>
        </div>
      </div>
    </div>
    <div class="form-row one">
      <div class="form-group full"><label>Ëá™Áî±„É°„É¢</label><textarea id="f-note" placeholder="Ë≥™ÊÑü„ÄÅ‰ΩôÈüª„ÄÅÂç∞Ë±°„Å™„Å©‚Ä¶"></textarea></div>
    </div>
    <div class="form-row one" style="margin-bottom:4px;">
      <div class="form-group full">
        <label>ÂÜôÁúüÔºàË§áÊï∞ÂèØÔºâ</label>
        <div class="img-upload-area" id="f-img-area">
          <input type="file" id="f-images" accept="image/*" multiple onchange="handleImageSelect(event,'f-img-preview')">
          <div class="img-upload-label">üì∑ „ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É≠„ÉÉ„Éó„Åó„Å¶ÁîªÂÉè„ÇíËøΩÂä† <span>ÔºàJPEG / PNG / WEBPÔºâ</span></div>
        </div>
        <div class="img-preview-row" id="f-img-preview"></div>
      </div>
    </div>
    <div class="form-actions"><button class="add-btn" onclick="addEntry()">Ôºã Ë®òÈå≤„Åô„Çã</button></div>
  </div>

  <div class="journal-header">
    <span class="journal-title">Journal</span>
    <span class="entry-count" id="entry-count"></span>
  </div>
  <div id="journal-list"></div>
</div>
</div>

<!-- PAGE: ARCHIVE -->
<div class="page" id="page-archive">
<div class="layout">
  <div class="month-nav" id="monthNav">
    <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
    <div class="month-display" id="monthDisplay" onclick="toggleMonthPicker()">
      <span id="monthDisplayText"></span>
      <span class="month-display-caret">‚ñº</span>
    </div>
    <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
    <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Éî„ÉÉ„Ç´„Éº -->
    <div class="month-picker" id="monthPicker">
      <div class="month-picker-header">
        <button class="month-picker-nav" onclick="pickerChangeYear(-1)">‚Äπ</button>
        <span class="month-picker-year" id="pickerYear"></span>
        <button class="month-picker-nav" onclick="pickerChangeYear(1)">‚Ä∫</button>
      </div>
      <div class="month-picker-grid" id="pickerGrid"></div>
    </div>
  </div>
  <!-- MONTHLY LOG CALENDAR -->
  <div class="monthly-log" id="monthlyLogCalendar">
    <div class="monthly-log-header">
      <span class="monthly-log-title">üóì Monthly Log</span>
      <div class="monthly-log-legend">
        <div class="monthly-log-legend-item"><span class="monthly-log-legend-dot" style="background:var(--navy)"></span>„Éõ„ÉÉ„Éà</div>
        <div class="monthly-log-legend-item"><span class="monthly-log-legend-dot" style="background:#4A90D9"></span>„Ç¢„Ç§„Çπ</div>
      </div>
    </div>
    <div class="monthly-log-grid" id="monthlyLogGrid"></div>
  </div>

  <div class="month-summary">
    <div class="month-stat" id="af-all" onclick="setArchiveFilter('all')" style="cursor:pointer;"><span class="month-stat-num" id="ms-total">0</span><span class="month-stat-label">ÂêàË®à</span></div>
    <div class="month-stat" id="af-hot" onclick="setArchiveFilter('hot')" style="cursor:pointer;"><span class="month-stat-num" id="ms-hot">0</span><span class="month-stat-label">„Éõ„ÉÉ„Éà</span></div>
    <div class="month-stat" id="af-iced" onclick="setArchiveFilter('iced')" style="cursor:pointer;"><span class="month-stat-num" id="ms-iced">0</span><span class="month-stat-label">„Ç¢„Ç§„Çπ</span></div>
    <div class="month-stat"><span class="month-stat-num" id="ms-avg">‚Äî</span><span class="month-stat-label">Âπ≥ÂùáË©ï‰æ°</span></div>
  </div>
  <div class="month-flavor-bar" id="monthFlavorBar" style="display:none;">
    <div class="month-flavor-title">‚óÜ „Çà„ÅèÈ£≤„Çì„Å†„Éï„É¨„Éº„Éê„Éº</div>
    <div id="monthFlavorBars"></div>
  </div>
  <div id="archive-list"></div>
</div>
</div>

<!-- PAGE: BEANS -->
<div class="page" id="page-beans">
<div class="layout">
  <div class="journal-header">
    <span class="journal-title">Ë±Ü„Éá„Éº„Çø„Éô„Éº„Çπ</span>
    <span class="entry-count" id="bean-count"></span>
  </div>
  <div class="bean-grid" id="beanGrid"></div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FLAVOR DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FLAVORS = {
  '„Éï„É´„Éº„ÉÑÁ≥ª':['„Éñ„É´„Éº„Éô„É™„Éº','„Çπ„Éà„É≠„Éô„É™„Éº','„É©„Ç∫„Éô„É™„Éº','„ÉÅ„Çß„É™„Éº','„Éó„É©„É†','„Éî„Éº„ÉÅ','„Ç¢„Éó„É™„Ç≥„ÉÉ„Éà','„Éû„É≥„Ç¥„Éº','„Éë„Éë„Ç§„É§','„Éë„Ç§„Éä„ÉÉ„Éó„É´','„Ç∑„Éà„É©„Çπ','„É¨„É¢„É≥','„Ç™„É¨„É≥„Ç∏','„Ç∞„É¨„Éº„Éó„Éï„É´„Éº„ÉÑ','„É©„Ç§„É†'],
  '„Éä„ÉÉ„ÉÑ / „ÉÅ„Éß„Ç≥':['„Ç¢„Éº„É¢„É≥„Éâ','„Éò„Éº„Çº„É´„Éä„ÉÉ„ÉÑ','„Ç¶„Ç©„Éº„É´„Éä„ÉÉ„ÉÑ','„ÉÄ„Éº„ÇØ„ÉÅ„Éß„Ç≥„É¨„Éº„Éà','„Éü„É´„ÇØ„ÉÅ„Éß„Ç≥„É¨„Éº„Éà','„Ç´„Ç´„Ç™„Éã„Éñ','„Ç≠„É£„É©„É°„É´','„Éà„Éï„Ç£„Éº','„Éê„Çø„Éº'],
  'Áîò„Åø / „Çπ„Ç§„Éº„ÉÑ':['ÈªíÁ≥ñ','„Éè„ÉÅ„Éü„ÉÑ','„É°„Éº„Éó„É´„Ç∑„É≠„ÉÉ„Éó','„Éê„Éã„É©','„ÇØ„É™„Éº„Éü„Éº','„Éû„Ç∏„Éë„É≥','„Éñ„É©„Ç¶„É≥„Ç∑„É•„Ç¨„Éº'],
  '„Éï„É≠„Éº„É©„É´ / „Éè„Éº„Éñ':['„Ç∏„É£„Çπ„Éü„É≥','„É©„Éô„É≥„ÉÄ„Éº','„É≠„Éº„Ç∫','„Ç®„É´„ÉÄ„Éº„Éï„É©„ÉØ„Éº','„Ç´„É¢„Éü„Éº„É´','„Éè„Éº„Éñ','Á¥ÖËå∂'],
  '„Çπ„Éë„Ç§„Çπ':['„Ç∑„Éä„É¢„É≥','„ÇØ„É≠„Éº„Éñ','„Ç´„É´„ÉÄ„É¢„É≥','„Éñ„É©„ÉÉ„ÇØ„Éö„ÉÉ„Éë„Éº','„Éä„ÉÑ„É°„Ç∞'],
  '„Åù„ÅÆ‰ªñ':['„Ç¢„Éº„Ç∑„Éº','„Ç¶„ÉÉ„Éá„Ç£','„Çπ„É¢„Éº„Ç≠„Éº','„ÉØ„Ç§„Éã„Éº','Áô∫ÈÖµÊÑü','Á©ÄÁâ©'],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sb = null;           // Supabase client
let currentUser = null;  // auth user object
let entries = [];
let beans = [];
let selectedFlavors = new Set();
let pendingImages = [];
let rating = 0;
let temp = 'hot';
let editingId = null;
let archiveMonth = { y: new Date().getFullYear(), m: new Date().getMonth() };
let editingBeanId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INIT & AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SupabaseÊé•Á∂öÊÉÖÂ†±Ôºà„Ç≥„Éº„Éâ„Å´Âüã„ÇÅËæº„ÅøÊ∏à„ÅøÔºâ
const SUPABASE_URL = 'https://cgamzijaczofkodtxvhd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnYW16aWphY3pvZmtvZHR4dmhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzExMzMsImV4cCI6MjA4NzQ0NzEzM30.ZIpnk0juSwt1W7Lydytr5opPuFpJ80mjYHjLu03Wm9U';

function getConfig() {
  return {
    url: SUPABASE_URL,
    key: SUPABASE_ANON_KEY
  };
}

function saveSetup() {
  const url = document.getElementById('setup-url').value.trim().replace(/\/$/,'');
  const key = document.getElementById('setup-key').value.trim();
  if (!url || !key) { alert('URL„Å®Key„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  localStorage.setItem('cj-sb-url', url);
  localStorage.setItem('cj-sb-key', key);
  location.reload();
}

async function signInWithGoogle() {
  if (!sb) return;
  const redirectTo = 'https://bjtrn25.github.io/coffee-journal/';
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo,
      skipBrowserRedirect: false,
      queryParams: { prompt: 'select_account' }
    }
  });
  if (error) alert('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ' + error.message);
}

async function signOut() {
  if (!sb) return;
  await sb.auth.signOut();
}

function showLoadingScreen(v) {
  document.getElementById('loadingScreen').classList.toggle('hidden', !v);
}
function showSetupScreen() {
  showLoadingScreen(false);
  document.getElementById('setupScreen').classList.remove('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
}
function showLoginScreen() {
  showLoadingScreen(false);
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('setupScreen').classList.add('hidden');
}
function showApp(user) {
  showLoadingScreen(false);
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('setupScreen').classList.add('hidden');
  currentUser = user;
  // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´ÂèçÊò†
  const name = user.user_metadata?.full_name || user.email || '„É¶„Éº„Ç∂„Éº';
  const avatar = user.user_metadata?.avatar_url;
  document.getElementById('userNameDisplay').textContent = name;
  const avatarEl = document.getElementById('userAvatar');
  if (avatar) { avatarEl.src = avatar; avatarEl.style.display = 'block'; }
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  loadAll();
}

// ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ
async function startup() {
  showLoadingScreen(true);
  const { url, key } = getConfig();
  // URL„Å®Key„ÅØÂüã„ÇÅËæº„ÅøÊ∏à„Åø„ÅÆ„Åü„ÇÅsetupÁîªÈù¢„ÅØË°®Á§∫„Åó„Å™„ÅÑ

  // Supabase „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñ
  sb = window.supabase.createClient(url, key);

  // Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
  sb.auth.onAuthStateChange((event, session) => {
    if (session?.user) {
      showApp(session.user);
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      showLoginScreen();
    }
  });

  // ÂàùÂõû„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) {
    showApp(session.user);
  } else {
    showLoginScreen();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA: LOAD & SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAll() {
  if (!sb || !currentUser) return;
  setStatus('syncing', 'ÂêåÊúü‰∏≠...');
  try {
    const [{ data: eData, error: eErr }, { data: bData, error: bErr }] = await Promise.all([
      sb.from('coffee_entries').select('*').order('drunk_at', { ascending: false }),
      sb.from('coffee_beans').select('*').order('created_at', { ascending: false })
    ]);
    if (eErr) throw eErr;
    if (bErr) throw bErr;
    entries = (eData || []).map(r => ({
      id: String(r.id), name: r.name, temp: r.temp || 'hot',
      place: r.place || '', datetime: r.drunk_at,
      process: r.process || '', roastLevel: r.roast_level || '',
      roastDate: r.roast_date || '', variety: r.variety || '',
      altitude: r.altitude || '', flavors: r.flavors || [],
      images: r.images || [], note: r.note || '',
      rating: r.rating || 0, beanId: r.bean_id || ''
    }));
    beans = (bData || []).map(r => ({
      id: String(r.id), name: r.name, variety: r.variety || '',
      country: r.country || '', region: r.region || '',
      altitude: r.altitude || '', process: r.process || '',
      roastLevel: r.roast_level || '', roastDate: r.roast_date || '',
      roaster: r.roaster || '', note: r.note || ''
    }));
    setStatus('ok', 'ÂêåÊúüÊ∏à');
  } catch(e) {
    console.error(e);
    setStatus('error', '„Ç®„É©„Éº');
  }
  renderJournal(); renderBeanSelect(); renderBeans();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENTRY CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addEntry() {
  if (!sb || !currentUser) return;
  const name = document.getElementById('f-name').value.trim();
  if (!name) { document.getElementById('f-name').focus(); return; }
  const dt = document.getElementById('f-datetime').value;
  const row = {
    user_id: currentUser.id,
    name, temp,
    place: document.getElementById('f-place').value.trim(),
    drunk_at: dt ? new Date(dt).toISOString() : new Date().toISOString(),
    process: document.getElementById('f-process').value,
    roast_level: document.getElementById('f-roast-level').value,
    roast_date: document.getElementById('f-roast-date').value || null,
    variety: document.getElementById('f-variety').value,
    altitude: document.getElementById('f-altitude').value ? Number(document.getElementById('f-altitude').value) : null,
    flavors: [...selectedFlavors],
    images: pendingImages.map(i => i.dataUrl),
    note: document.getElementById('f-note').value.trim(),
    rating,
    bean_id: document.getElementById('f-bean-ref').value || null
  };
  setStatus('syncing', '‰øùÂ≠ò‰∏≠...');
  const { data, error } = await sb.from('coffee_entries').insert(row).select().single();
  if (error) { console.error(error); setStatus('error', '‰øùÂ≠ò„Ç®„É©„Éº'); return; }
  entries.unshift({
    id: String(data.id), name: data.name, temp: data.temp,
    place: data.place || '', datetime: data.drunk_at,
    process: data.process || '', roastLevel: data.roast_level || '',
    roastDate: data.roast_date || '', variety: data.variety || '',
    altitude: data.altitude || '', flavors: data.flavors || [],
    images: data.images || [], note: data.note || '',
    rating: data.rating || 0, beanId: data.bean_id || ''
  });
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  renderJournal(); resetForm();
}

async function deleteEntry(id) {
  const ok = await showConfirm('„Åì„ÅÆ„Ç®„É≥„Éà„É™„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');
  if (!ok) return;
  const { error } = await sb.from('coffee_entries').delete().eq('id', id);
  if (error) { console.error(error); setStatus('error', 'ÂâäÈô§„Ç®„É©„Éº'); return; }
  entries = entries.filter(e => e.id !== id);
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  renderJournal();
}

function startEdit(id) { editingId = id; renderJournal(); }
function cancelEdit() { editingId = null; renderJournal(); }

async function saveEdit(id) {
  const idx = entries.findIndex(e => e.id === id);
  if (idx < 0) return;
  const e = entries[idx];
  const hb = document.querySelector(`[data-etid="${id}"][data-tv="hot"]`);
  let nr = 0;
  document.querySelectorAll(`[data-esid="${id}"]`).forEach(s => { if (s.classList.contains('active')) nr = +s.dataset.sv; });
  const newImages = (window._editImages !== null && window._editImages !== undefined)
    ? window._editImages.map(i => i.dataUrl || i)
    : (e.images || []);
  const row = {
    name: document.getElementById('ee-name-'+id).value.trim() || e.name,
    temp: hb && hb.classList.contains('active') ? 'hot' : 'iced',
    place: document.getElementById('ee-place-'+id).value.trim(),
    drunk_at: (() => { const v = document.getElementById('ee-dt-'+id).value; return v ? new Date(v).toISOString() : e.datetime; })(),
    process: document.getElementById('ee-process-'+id).value,
    roast_level: document.getElementById('ee-rl-'+id).value,
    roast_date: document.getElementById('ee-rd-'+id).value || null,
    variety: document.getElementById('ee-variety-'+id).value.trim(),
    note: document.getElementById('ee-note-'+id).value.trim(),
    flavors: [...(window._editFlavors || new Set())],
    images: newImages,
    rating: nr || e.rating
  };
  setStatus('syncing', 'Êõ¥Êñ∞‰∏≠...');
  const { error } = await sb.from('coffee_entries').update(row).eq('id', id);
  if (error) { console.error(error); setStatus('error', 'Êõ¥Êñ∞„Ç®„É©„Éº'); return; }
  Object.assign(e, {
    name: row.name, temp: row.temp, place: row.place,
    datetime: row.drunk_at, process: row.process,
    roastLevel: row.roast_level, roastDate: row.roast_date || '',
    variety: row.variety, note: row.note,
    flavors: row.flavors, images: row.images, rating: row.rating
  });
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  editingId = null; window._editFlavors = null; window._editImages = null;
  renderJournal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEAN CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBeanModal(id) {
  editingBeanId = id || null;
  document.getElementById('beanModalTitle').textContent = id ? 'Ë±Ü„ÇíÁ∑®ÈõÜ' : 'Ë±Ü„ÇíÁôªÈå≤';
  if (id) {
    const b = beans.find(b => b.id === id);
    if (b) {
      document.getElementById('bm-name').value = b.name;
      document.getElementById('bm-variety').value = b.variety || '';
      document.getElementById('bm-country').value = b.country || '';
      document.getElementById('bm-region').value = b.region || '';
      document.getElementById('bm-altitude').value = b.altitude || '';
      document.getElementById('bm-process').value = b.process || '';
      document.getElementById('bm-roast').value = b.roastLevel || '';
      document.getElementById('bm-roastdate').value = b.roastDate || '';
      document.getElementById('bm-roaster').value = b.roaster || '';
      document.getElementById('bm-note').value = b.note || '';
    }
  } else {
    ['bm-name','bm-region','bm-altitude','bm-roaster','bm-note','bm-roastdate'].forEach(i => { const el=document.getElementById(i); if(el) el.value=''; });
    ['bm-variety','bm-country','bm-process','bm-roast'].forEach(i => { const el=document.getElementById(i); if(el) el.value=''; });
  }
  document.getElementById('beanModal').classList.remove('hidden');
}
function closeBeanModal() { document.getElementById('beanModal').classList.add('hidden'); editingBeanId = null; }

async function saveBean() {
  if (!sb || !currentUser) return;
  const name = document.getElementById('bm-name').value.trim();
  if (!name) { document.getElementById('bm-name').focus(); return; }
  const row = {
    user_id: currentUser.id,
    name,
    variety: document.getElementById('bm-variety').value,
    country: document.getElementById('bm-country').value,
    region: document.getElementById('bm-region').value.trim(),
    altitude: document.getElementById('bm-altitude').value ? Number(document.getElementById('bm-altitude').value) : null,
    process: document.getElementById('bm-process').value,
    roast_level: document.getElementById('bm-roast').value,
    roast_date: document.getElementById('bm-roastdate').value || null,
    roaster: document.getElementById('bm-roaster').value.trim(),
    note: document.getElementById('bm-note').value.trim()
  };
  setStatus('syncing', '‰øùÂ≠ò‰∏≠...');
  if (editingBeanId) {
    const { error } = await sb.from('coffee_beans').update(row).eq('id', editingBeanId);
    if (error) { console.error(error); setStatus('error', '‰øùÂ≠ò„Ç®„É©„Éº'); return; }
    const i = beans.findIndex(b => b.id === editingBeanId);
    if (i >= 0) beans[i] = { ...beans[i], ...row, id: editingBeanId, roastLevel: row.roast_level, roastDate: row.roast_date || '' };
  } else {
    const { data, error } = await sb.from('coffee_beans').insert(row).select().single();
    if (error) { console.error(error); setStatus('error', '‰øùÂ≠ò„Ç®„É©„Éº'); return; }
    beans.unshift({ id: String(data.id), name: data.name, variety: data.variety || '', country: data.country || '', region: data.region || '', altitude: data.altitude || '', process: data.process || '', roastLevel: data.roast_level || '', roastDate: data.roast_date || '', roaster: data.roaster || '', note: data.note || '' });
  }
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  closeBeanModal(); renderBeans(); renderBeanSelect();
}

async function deleteBean(id) {
  const ok = await showConfirm('„Åì„ÅÆË±Ü„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');
  if (!ok) return;
  const { error } = await sb.from('coffee_beans').delete().eq('id', id);
  if (error) { console.error(error); setStatus('error', 'ÂâäÈô§„Ç®„É©„Éº'); return; }
  beans = beans.filter(b => b.id !== id);
  setStatus('ok', 'ÂêåÊúüÊ∏à');
  renderBeans(); renderBeanSelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIRM DIALOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _confirmResolve = null;
function showConfirm(msg) {
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmModal').classList.remove('hidden');
  return new Promise(r => { _confirmResolve = r; });
}
function confirmResolve(v) {
  document.getElementById('confirmModal').classList.add('hidden');
  if (_confirmResolve) { _confirmResolve(v); _confirmResolve = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const navBtns = document.querySelectorAll('.nav-tab');
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  navBtns.forEach((b,i) => b.classList.toggle('active', ['journal','archive','beans','insights'][i] === name));
  if (name === 'archive') renderArchive();
  if (name === 'beans') renderBeans();
  if (name === 'insights') renderInsights();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTemp(t) {
  temp = t;
  document.getElementById('btn-hot').classList.toggle('active', t === 'hot');
  document.getElementById('btn-iced').classList.toggle('active', t === 'iced');
}

function setupStars(rowId, getVal, setVal) {
  const row = document.getElementById(rowId);
  if (!row) return;
  row.querySelectorAll('.star').forEach(s => {
    s.addEventListener('click', () => { setVal(+s.dataset.v); refreshStars(rowId, getVal()); });
    s.addEventListener('mouseover', () => row.querySelectorAll('.star').forEach(x => x.classList.toggle('active', +x.dataset.v <= +s.dataset.v)));
    s.addEventListener('mouseout', () => refreshStars(rowId, getVal()));
  });
}
function refreshStars(rowId, val) {
  document.getElementById(rowId)?.querySelectorAll('.star').forEach(x => x.classList.toggle('active', +x.dataset.v <= val));
}

function autofillFromBean() {
  const beanId = document.getElementById('f-bean-ref').value;
  if (!beanId) return;
  const b = beans.find(b => b.id === beanId);
  if (!b) return;
  if (!document.getElementById('f-name').value) document.getElementById('f-name').value = b.name;
  if (!document.getElementById('f-variety').value) document.getElementById('f-variety').value = b.variety || '';
  if (!document.getElementById('f-process').value) document.getElementById('f-process').value = b.process || '';
  if (!document.getElementById('f-roast-level').value) document.getElementById('f-roast-level').value = b.roastLevel || '';
  if (!document.getElementById('f-roast-date').value) document.getElementById('f-roast-date').value = b.roastDate || '';
  if (!document.getElementById('f-altitude').value) document.getElementById('f-altitude').value = b.altitude || '';
}

function resetForm() {
  ['f-name','f-place','f-note','f-roast-date'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  ['f-process','f-roast-level','f-bean-ref','f-variety'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  const alt = document.getElementById('f-altitude'); if(alt) alt.value = '';
  pendingImages = [];
  const prev = document.getElementById('f-img-preview'); if(prev) prev.innerHTML = '';
  rating = 0; temp = 'hot'; selectedFlavors = new Set();
  setTemp('hot'); refreshStars('stars', 0);
  buildFlavorUI('flavorCategories');
  const n = new Date(); n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
  document.getElementById('f-datetime').value = n.toISOString().slice(0,16);
}
document.getElementById('f-name').addEventListener('keydown', e => { if(e.key === 'Enter') addEntry(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FLAVOR UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFlavorUI(containerId, currentSel) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const selSet = currentSel instanceof Set ? currentSel : new Set(Array.isArray(currentSel) ? currentSel : []);
  el.innerHTML = Object.entries(FLAVORS).map(([cat,items]) => `
    <div class="flavor-cat-label">${cat}</div>
    <div class="flavor-chips">${items.map(f=>`<button type="button" class="flavor-chip${selSet.has(f)?' selected':''}" data-f="${escAttr(f)}" data-cid="${containerId}">${escHTML(f)}</button>`).join('')}</div>
  `).join('');
  el.querySelectorAll('.flavor-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      const f = btn.dataset.f;
      const set = btn.dataset.cid === 'flavorCategories' ? selectedFlavors : window._editFlavors;
      if (!set) return;
      set.has(f) ? set.delete(f) : set.add(f);
      btn.classList.toggle('selected', set.has(f));
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMAGE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processImageFile(file, callback) {
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      const MAX = 1200; let w = img.width, h = img.height;
      if (w > MAX || h > MAX) { if (w > h) { h=Math.round(h*MAX/w); w=MAX; } else { w=Math.round(w*MAX/h); h=MAX; } }
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      callback(canvas.toDataURL('image/jpeg', 0.82), file.name);
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function handleImageSelect(event, previewId) {
  Array.from(event.target.files).filter(f=>f.type.startsWith('image/')).forEach(file => {
    processImageFile(file, (dataUrl, name) => {
      pendingImages.push({ dataUrl, name });
      renderImagePreview(previewId, pendingImages, true);
    });
  });
  event.target.value = '';
}

function handleEditImageSelect(event, entryId) {
  Array.from(event.target.files).filter(f=>f.type.startsWith('image/')).forEach(file => {
    processImageFile(file, (dataUrl, name) => {
      if (!window._editImages) window._editImages = [];
      window._editImages.push({ dataUrl, name });
      renderImagePreview('ei-preview-'+entryId, window._editImages, false, entryId);
    });
  });
  event.target.value = '';
}

function renderImagePreview(containerId, images, isPending, editId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = images.map((img, i) => `
    <div class="img-thumb-wrap">
      <img class="img-thumb" src="${img.dataUrl||img}" onclick="openLightbox(${JSON.stringify(images.map(x=>x.dataUrl||x))},${i})">
      <button class="img-thumb-del" onclick="${isPending?`removePendingImage(${i},'${containerId}')`:`removeEditImage(${i},'${escAttr(containerId)}','${escAttr(editId||'')}')`}">√ó</button>
    </div>`).join('');
}

function removePendingImage(idx, previewId) { pendingImages.splice(idx,1); renderImagePreview(previewId, pendingImages, true); }
function removeEditImage(idx, previewId, entryId) { if(!window._editImages)return; window._editImages.splice(idx,1); renderImagePreview(previewId, window._editImages, false, entryId); }

function setupImageDrop(areaId, previewId) {
  const area = document.getElementById(areaId);
  if (!area) return;
  area.addEventListener('dragover', e => { e.preventDefault(); area.style.borderColor='var(--yellow)'; });
  area.addEventListener('dragleave', () => { area.style.borderColor=''; });
  area.addEventListener('drop', e => {
    e.preventDefault(); area.style.borderColor='';
    Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')).forEach(file => {
      processImageFile(file, (dataUrl, name) => { pendingImages.push({dataUrl,name}); renderImagePreview(previewId, pendingImages, true); });
    });
  });
}

// ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ
let _lbImages = [], _lbIdx = 0;
function openLightbox(images, idx) {
  _lbImages = Array.isArray(images) ? images : [images]; _lbIdx = idx||0;
  updateLightbox();
  document.getElementById('lightbox').classList.remove('hidden');
  document.addEventListener('keydown', lightboxKey);
}
function closeLightbox() { document.getElementById('lightbox').classList.add('hidden'); document.removeEventListener('keydown', lightboxKey); }
function lightboxStep(d) { _lbIdx = (_lbIdx+d+_lbImages.length)%_lbImages.length; updateLightbox(); }
function updateLightbox() {
  document.getElementById('lightboxImg').src = _lbImages[_lbIdx];
  document.getElementById('lightboxCounter').textContent = _lbImages.length>1 ? `${_lbIdx+1} / ${_lbImages.length}` : '';
  document.querySelector('.lightbox-nav.prev').style.display = _lbImages.length>1?'':'none';
  document.querySelector('.lightbox-nav.next').style.display = _lbImages.length>1?'':'none';
}
function lightboxKey(e) { if(e.key==='Escape')closeLightbox(); if(e.key==='ArrowLeft')lightboxStep(-1); if(e.key==='ArrowRight')lightboxStep(1); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARE CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _shareEntry = null;

function openShareModal(entryId) {
  const e = entries.find(x => x.id === entryId);
  if (!e) return;
  _shareEntry = e;
  document.getElementById('shareModal').classList.remove('hidden');
  // Web Share APIÂØæÂøú„ÉÅ„Çß„ÉÉ„ÇØ
  if (navigator.share && navigator.canShare) {
    document.getElementById('shareNativeBtn').style.display = 'flex';
  }
  // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„ÇâCanvasÊèèÁîªÔºà„É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Å¶„Åã„ÇâÔºâ
  setTimeout(() => drawShareCard(e), 50);
}

function closeShareModal() {
  document.getElementById('shareModal').classList.add('hidden');
  _shareEntry = null;
}

// ÁÑôÁÖéÂ∫¶Âà•„Ç´„É©„Éº„ÉÜ„Éº„ÉûÔºà„É¶„Éº„Ç∂„ÉºÊåáÂÆö„Ç´„É©„Éº„Çí„Ç¢„ÇØ„Çª„É≥„Éà„Å´‰ΩøÁî®Ôºâ
// accent = „É¶„Éº„Ç∂„ÉºÊåáÂÆö„Ç´„É©„Éº„Åù„ÅÆ„Åæ„Åæ
// bg = „Åù„ÅÆ„Ç´„É©„Éº„ÇíÊöó„Åè„Åó„Åü„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ
const ROAST_THEMES = {
  // „É©„Ç§„Éà: #D9F7A2 ‚Üí Ê∏ÖÊæÑ„Å™ÈªÑÁ∑ë„Ç¢„ÇØ„Çª„É≥„Éà„ÄÅÊ∑±„ÅÑÁ∑ëËÉåÊôØ
  '„É©„Ç§„Éà':     { bg: ['#1a3020','#2a4a2c','#223828'], accent: '#D9F7A2', circle: '#D9F7A2' },
  // „Ç∑„Éä„É¢„É≥: #F6DE8B ‚Üí Ê∏©„Åã„ÅÑÈªÑËâ≤„Ç¢„ÇØ„Çª„É≥„Éà„ÄÅÊ∑±„ÅÑ„Ç¢„É≥„Éê„ÉºËÉåÊôØ
  '„Ç∑„Éä„É¢„É≥':   { bg: ['#3a2c08','#564018','#463412'], accent: '#F6DE8B', circle: '#F6DE8B' },
  // „Éü„Éá„Ç£„Ç¢„É†: #E8C36A ‚Üí „Ç¥„Éº„É´„Éá„É≥„Ç¢„É≥„Éê„Éº„ÄÅÊ∑±„ÅÑ„Ç¶„Ç©„Éº„É†„Éñ„É©„Ç¶„É≥ËÉåÊôØ
  '„Éü„Éá„Ç£„Ç¢„É†': { bg: ['#38240a','#543612','#44300e'], accent: '#E8C36A', circle: '#E8C36A' },
  // „Éè„Ç§: #A95522 ‚Üí Ê∑±„ÅÑ„Ç™„É¨„É≥„Ç∏„Éñ„É©„Ç¶„É≥„ÄÅÊ∑±„ÅÑ„ÉÜ„É©„Ç≥„ÉÉ„ÇøËÉåÊôØ
  '„Éè„Ç§':       { bg: ['#321c08','#4e2c0e','#40240a'], accent: '#C87040', circle: '#C87040' },
  // „Ç∑„ÉÜ„Ç£: #8B4A2A ‚Üí Ê∑±„ÅÑËµ§Ë§êËâ≤ËÉåÊôØ
  '„Ç∑„ÉÜ„Ç£':     { bg: ['#2a1608','#40200c','#341a08'], accent: '#B86840', circle: '#B86840' },
  // „Éï„É´„Ç∑„ÉÜ„Ç£: #5B2D1A ‚Üí Ê∑±„ÅÑ„ÉÄ„Éº„ÇØ„Éñ„É©„Ç¶„É≥ËÉåÊôØ
  '„Éï„É´„Ç∑„ÉÜ„Ç£': { bg: ['#1c0c06','#2e1608','#241006'], accent: '#A06040', circle: '#A06040' },
  // „Éï„É¨„É≥„ÉÅ: ÊåáÂÆö„Å™„Åó‚ÜíÊ∑±„ÅÑ„ÉÅ„Éß„Ç≥„É¨„Éº„ÉàËÉåÊôØ
  '„Éï„É¨„É≥„ÉÅ':   { bg: ['#140a04','#220e06','#1a0c04'], accent: '#885030', circle: '#885030' },
  // „Ç§„Çø„É™„Ç¢„É≥: ÊåáÂÆö„Å™„Åó‚ÜíÊúÄÊ∑±„ÅÆ„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩËÉåÊôØ
  '„Ç§„Çø„É™„Ç¢„É≥': { bg: ['#0e0804','#1a0c04','#140a04'], accent: '#704020', circle: '#704020' },
};

function getRoastTheme(roastLevel) {
  return ROAST_THEMES[roastLevel] || { bg: ['#052D57','#0a3d6e','#0d4a85'], accent: '#FFBD00', circle: '#FFBD00' };
}

function drawShareCard(e) {
  const canvas = document.getElementById('shareCanvas');
  const W = 800, H = 460;
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  // --- ÁÑôÁÖéÂ∫¶Âà•„ÉÜ„Éº„ÉûÂèñÂæó ---
  const theme = getRoastTheme(e.roastLevel);

  // --- ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ ---
  const grad = ctx.createLinearGradient(0, 0, W, H);
  grad.addColorStop(0, theme.bg[0]);
  grad.addColorStop(0.6, theme.bg[1]);
  grad.addColorStop(1, theme.bg[2]);
  ctx.fillStyle = grad;
  ctx.beginPath();
  roundRect(ctx, 0, 0, W, H, 0);
  ctx.fill();

  // --- Ë£ÖÈ£æ: Âè≥‰∏ä„ÅÆÂ§ß„Åç„Å™ÂÜÜ ---
  ctx.save();
  ctx.globalAlpha = 0.08;
  ctx.fillStyle = theme.circle;
  ctx.beginPath();
  ctx.arc(W - 80, -60, 200, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // --- Ë£ÖÈ£æ: Â∑¶‰∏ã„ÅÆÂ∞è„Åï„Å™ÂÜÜ ---
  ctx.save();
  ctx.globalAlpha = 0.05;
  ctx.fillStyle = theme.circle;
  ctx.beginPath();
  ctx.arc(60, H + 40, 140, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // --- „É≠„Ç¥„Éû„Éº„ÇØ ---
  ctx.save();
  ctx.fillStyle = theme.accent;
  ctx.beginPath();
  ctx.arc(52, 52, 22, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = theme.bg[0];
  ctx.font = 'bold 18px serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('‚òï', 52, 53);
  ctx.restore();

  // --- „Ç¢„Éó„É™Âêç ---
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.font = '500 12px "Noto Sans JP", sans-serif';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  ctx.fillText('Coffee Journal', 82, 52);

  // --- ÁÑôÁÖéÂ∫¶„Éê„ÉÉ„Ç∏ÔºàÁÑôÁÖéÂ∫¶„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫Ôºâ ---
  if (e.roastLevel) {
    const rw = ctx.measureText(e.roastLevel).width + 24;
    ctx.fillStyle = `${theme.accent}33`;
    ctx.beginPath();
    roundRect(ctx, W - 48 - rw, 32, rw, 22, 11);
    ctx.fill();
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 11px "Noto Sans JP", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(e.roastLevel, W - 48 - rw / 2, 43);
  }

  // --- Ê∏©Â∫¶„Éê„ÉÉ„Ç∏ ---
  const isIced = e.temp === 'iced';
  const badgeText = isIced ? 'üßä ICED' : '‚òï HOT';
  ctx.fillStyle = isIced ? 'rgba(100,180,255,0.18)' : `${theme.accent}2e`;
  ctx.beginPath();
  roundRect(ctx, 48, 90, 80, 26, 13);
  ctx.fill();
  ctx.fillStyle = isIced ? '#64b4ff' : theme.accent;
  ctx.font = 'bold 11px "Noto Sans JP", sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(badgeText, 88, 103);

  // --- „Ç≥„Éº„Éí„ÉºÂêçÔºàÂ§ß„Åç„ÅèÔºâ ---
  ctx.fillStyle = '#ffffff';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  const nameText = e.name || '';
  const nameFontSize = nameText.length > 20 ? 28 : nameText.length > 14 ? 32 : 38;
  ctx.font = `bold ${nameFontSize}px "Noto Sans JP", sans-serif`;
  ctx.fillText(truncateText(ctx, nameText, W - 96), 48, 134);

  // --- Â†¥ÊâÄ ---
  let metaY = 134 + nameFontSize + 10;
  if (e.place) {
    ctx.fillStyle = 'rgba(255,255,255,0.55)';
    ctx.font = '400 14px "Noto Sans JP", sans-serif';
    ctx.fillText('üìç ' + e.place, 48, metaY);
    metaY += 24;
  }

  // --- Êó•ÊôÇ ---
  if (e.datetime) {
    const d = new Date(e.datetime);
    const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}  ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '300 12px "Noto Sans JP", sans-serif';
    ctx.fillText(dateStr, 48, metaY);
    metaY += 22;
  }

  // --- Âå∫Âàá„ÇäÁ∑ö ---
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(48, metaY + 6);
  ctx.lineTo(W - 48, metaY + 6);
  ctx.stroke();
  metaY += 22;

  // --- „Çø„Ç∞Áæ§ÔºàÂìÅÁ®Æ„Éª„Éó„É≠„Çª„Çπ„ÉªÊ®ôÈ´ò„ÉªÁÑôÁÖéÊó•‚ÄîÁÑôÁÖéÂ∫¶„ÅØÂè≥‰∏ä„Å´ÁßªÂãï„Åó„Åü„ÅÆ„ÅßÈô§Â§ñÔºâ ---
  const tags = [];
  if (e.variety) tags.push({ text: e.variety, color: 'rgba(180,140,255,0.25)', textColor: '#c8a8ff' });
  if (e.process) tags.push({ text: e.process, color: 'rgba(100,180,255,0.2)', textColor: '#82c8ff' });
  if (e.altitude) tags.push({ text: e.altitude + ' masl', color: 'rgba(100,220,150,0.18)', textColor: '#80e0a0' });
  if (e.roastDate) {
    const rd = new Date(e.roastDate + 'T12:00:00');
    const rdStr = `ÁÑôÁÖé ${rd.getFullYear()}/${String(rd.getMonth()+1).padStart(2,'0')}/${String(rd.getDate()).padStart(2,'0')}`;
    const roastDaysCard = Math.floor((new Date() - rd) / 86400000);
    tags.push({ text: rdStr + `Ôºà${roastDaysCard}Êó•ÂâçÔºâ`, color: 'rgba(255,200,100,0.18)', textColor: '#ffd580' });
  }

  let tagX = 48;
  ctx.font = '500 11px "Noto Sans JP", sans-serif';
  tags.forEach(tag => {
    const tw = ctx.measureText(tag.text).width;
    const pw = tw + 20;
    if (tagX + pw > W - 48) return;
    ctx.fillStyle = tag.color;
    ctx.beginPath();
    roundRect(ctx, tagX, metaY, pw, 22, 11);
    ctx.fill();
    ctx.fillStyle = tag.textColor;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(tag.text, tagX + pw / 2, metaY + 11);
    tagX += pw + 8;
  });
  metaY += 34;

  // --- „Éï„É¨„Éº„Éê„Éº„Éé„Éº„Éà ---
  const flavors = (e.flavors || []).slice(0, 8);
  if (flavors.length > 0) {
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '700 10px "Noto Sans JP", sans-serif';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText('FLAVOR NOTES', 48, metaY);
    metaY += 18;

    let fx = 48;
    ctx.font = '400 12px "Noto Sans JP", sans-serif';
    flavors.forEach(f => {
      const fw = ctx.measureText(f).width;
      const fp = fw + 18;
      if (fx + fp > W - 48) return;
      ctx.fillStyle = 'rgba(26,122,74,0.3)';
      ctx.beginPath();
      roundRect(ctx, fx, metaY, fp, 22, 11);
      ctx.fill();
      ctx.fillStyle = '#80e0b0';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(f, fx + fp / 2, metaY + 11);
      fx += fp + 6;
    });
    metaY += 34;
  }

  // --- „É°„É¢ ---
  if (e.note) {
    ctx.fillStyle = 'rgba(255,255,255,0.55)';
    ctx.font = 'italic 13px "Noto Sans JP", sans-serif';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    const maxNoteW = W - 96;
    const noteLines = wrapText(ctx, '"' + e.note + '"', maxNoteW);
    noteLines.slice(0, 2).forEach((line, i) => {
      ctx.fillText(line, 48, metaY + i * 20);
    });
    metaY += Math.min(noteLines.length, 2) * 20 + 8;
  }

  // --- Ë©ï‰æ°ÔºàÊòüÔºâ ---
  if (e.rating) {
    const starY = H - 52;
    ctx.font = '18px serif';
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'left';
    for (let i = 1; i <= 5; i++) {
      ctx.fillStyle = i <= e.rating ? theme.accent : 'rgba(255,255,255,0.2)';
      ctx.fillText('‚òÖ', 48 + (i - 1) * 24, starY);
    }
  }

  // --- Âè≥ÂÅ¥: „Ç≥„Éº„Éí„ÉºÁîªÂÉèÔºà„ÅÇ„Çå„Å∞Ôºâ ---
  if (e.images && e.images.length > 0) {
    const img = new Image();
    img.onload = () => {
      const imgSize = 160;
      const imgX = W - 48 - imgSize;
      const imgY = H - 48 - imgSize;
      ctx.save();
      ctx.beginPath();
      roundRect(ctx, imgX, imgY, imgSize, imgSize, 12);
      ctx.clip();
      // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Ç´„Éê„Éº
      const scale = Math.max(imgSize / img.width, imgSize / img.height);
      const sw = imgSize / scale, sh = imgSize / scale;
      const sx = (img.width - sw) / 2, sy = (img.height - sh) / 2;
      ctx.drawImage(img, sx, sy, sw, sh, imgX, imgY, imgSize, imgSize);
      ctx.restore();
      // ÁîªÂÉè„ÅÆ‰∏ä„Å´ËñÑ„ÅÑ„Ç™„Éº„Éê„Éº„É¨„Ç§
      ctx.save();
      ctx.globalAlpha = 0.2;
      ctx.fillStyle = theme.bg[0];
      ctx.beginPath();
      roundRect(ctx, imgX, imgY, imgSize, imgSize, 12);
      ctx.fill();
      ctx.restore();
    };
    img.src = e.images[0];
  }
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function truncateText(ctx, text, maxWidth) {
  if (ctx.measureText(text).width <= maxWidth) return text;
  let t = text;
  while (t.length > 0 && ctx.measureText(t + '...').width > maxWidth) t = t.slice(0, -1);
  return t + '...';
}

function wrapText(ctx, text, maxWidth) {
  const words = text.split('');
  const lines = [];
  let line = '';
  for (const ch of words) {
    const test = line + ch;
    if (ctx.measureText(test).width > maxWidth && line.length > 0) {
      lines.push(line);
      line = ch;
    } else {
      line = test;
    }
  }
  if (line) lines.push(line);
  return lines;
}

function expandShareCard() {
  const canvas = document.getElementById('shareCanvas');
  const overlay = document.getElementById('shareExpandOverlay');
  const img = document.getElementById('shareExpandImg');
  img.src = canvas.toDataURL('image/png');
  overlay.style.display = 'flex';
  // Esc„Ç≠„Éº„ÅßÈñâ„Åò„Çã
  document._shareExpandKeyHandler = (e) => { if (e.key === 'Escape') closeExpandCard(); };
  document.addEventListener('keydown', document._shareExpandKeyHandler);
}

function closeExpandCard() {
  document.getElementById('shareExpandOverlay').style.display = 'none';
  if (document._shareExpandKeyHandler) {
    document.removeEventListener('keydown', document._shareExpandKeyHandler);
    document._shareExpandKeyHandler = null;
  }
}

function downloadShareCard() {
  const canvas = document.getElementById('shareCanvas');
  const name = (_shareEntry?.name || 'coffee').replace(/[^a-zA-Z0-9\u3000-\u9fff]/g, '_').slice(0, 30);
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = `coffee_journal_${name}.png`;
  a.click();
}

async function nativeShare() {
  const canvas = document.getElementById('shareCanvas');
  const name = (_shareEntry?.name || 'coffee').replace(/[^a-zA-Z0-9\u3000-\u9fff]/g, '_').slice(0, 30);
  try {
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const file = new File([blob], `coffee_journal_${name}.png`, { type: 'image/png' });
    if (navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: `${_shareEntry?.name || 'Coffee'} - Coffee Journal`,
        text: (_shareEntry?.flavors || []).join(' / '),
        files: [file]
      });
    } else {
      downloadShareCard();
    }
  } catch(err) {
    if (err.name !== 'AbortError') downloadShareCard();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(state, text) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot'+(state==='ok'?' ok':state==='syncing'?' syncing':'');
  document.getElementById('statusText').textContent = text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: JOURNAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// „Ç∏„É£„Éº„Éä„É´„Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã
let journalFilter = 'all'; // 'all' | 'today' | 'hot' | 'iced'

function setJournalFilter(f) {
  // Âêå„Åò„Çø„Éñ„ÇíÂÜç„Çø„ÉÉ„Éó„Åó„Åü„ÇâËß£Èô§ÔºàÂêàË®à„ÅØÂ∏∏„Å´Ëß£Èô§„Åß„Åç„Å™„ÅÑÔºâ
  journalFilter = (journalFilter === f && f !== 'all') ? 'all' : f;
  renderJournal();
}

function renderJournal() {
  const today = new Date().toISOString().split('T')[0];
  // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®ÔºàÂêàË®à„Éª‰ªäÊó•„ÅÆ„ÅøÔºâ
  let filtered = entries;
  if (journalFilter === 'today') filtered = entries.filter(e=>(e.datetime||'').startsWith(today));
  // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÊõ¥Êñ∞ÔºàÂêàË®à„Éª‰ªäÊó•„ÅÆ„ÅøÔºâ
  ['all','today'].forEach(key => {
    const el = document.getElementById('filter-'+key);
    if (!el) return;
    // „ÄåÂêàË®à„Äç„ÅØ„Éï„Ç£„É´„Çø„Éº„Å™„Åó„ÅÆÊôÇ„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÄÅ„Äå‰ªäÊó•„Äç„ÅØÈÅ∏ÊäûÊôÇ„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
    if (key === 'all') {
      el.classList.toggle('filter-active', journalFilter === 'all');
    } else if (key === 'today') {
      el.classList.toggle('filter-active', journalFilter === 'today');
      el.classList.toggle('accent', journalFilter !== 'today');
    }
  });
  const list = document.getElementById('journal-list');
  if (filtered.length === 0) {
    const emptyMsg = journalFilter !== 'all'
      ? `<div class="empty"><div class="empty-icon">${journalFilter==='hot'?'‚òï':journalFilter==='iced'?'üß£':'üìÖ'}</div>Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`
      : `<div class="empty"><div class="empty-icon">‚òï</div>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>ÊúÄÂàù„ÅÆ‰∏ÄÊùØ„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</div>`;
    list.innerHTML = emptyMsg;
  } else {
    const groups = {};
    filtered.forEach(e => { const d=(e.datetime||'').split('T')[0]; (groups[d]=groups[d]||[]).push(e); });
    list.innerHTML = Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(date => {
      const label = formatDate(new Date(date+'T12:00:00'));
      return `<div class="date-group"><div class="date-label"><span>${label}</span></div>${groups[date].map(renderEntryCard).join('')}</div>`;
    }).join('');
  }
  document.getElementById('stat-total').textContent = entries.length;
  document.getElementById('stat-today').textContent = entries.filter(e=>(e.datetime||'').startsWith(today)).length;
  document.getElementById('stat-hot').textContent = entries.filter(e=>e.temp==='hot').length;
  document.getElementById('stat-iced').textContent = entries.filter(e=>e.temp==='iced').length;
  document.getElementById('entry-count').textContent = (journalFilter==='all'?entries.length:filtered.length)+' ‰ª∂';
  // bind edit stars
  document.querySelectorAll('[data-esid]').forEach(s => {
    s.addEventListener('click', () => { const sid=s.dataset.esid; document.querySelectorAll(`[data-esid="${sid}"]`).forEach(x=>x.classList.toggle('active',+x.dataset.sv<=+s.dataset.sv)); });
    s.addEventListener('mouseover', () => { const sid=s.dataset.esid; document.querySelectorAll(`[data-esid="${sid}"]`).forEach(x=>x.classList.toggle('active',+x.dataset.sv<=+s.dataset.sv)); });
    s.addEventListener('mouseout', () => { const sid=s.dataset.esid; let cur=0; document.querySelectorAll(`[data-esid="${sid}"]`).forEach(x=>{if(x.classList.contains('active'))cur=Math.max(cur,+x.dataset.sv);}); document.querySelectorAll(`[data-esid="${sid}"]`).forEach(x=>x.classList.toggle('active',+x.dataset.sv<=cur)); });
  });
}

function renderEntryCard(e) {
  const icon = e.temp==='iced'?'üßä':'‚òï';
  const timeStr = e.datetime ? formatTime(new Date(e.datetime)) : '';
  const roastDays = e.roastDate ? Math.floor((new Date()-new Date(e.roastDate+'T12:00:00'))/86400000) : null;
  const flavors = e.flavors||[];

  if (editingId === e.id) {
    window._editFlavors = new Set(flavors);
    window._editImages = (e.images||[]).map(src => ({dataUrl:src, name:'photo'}));
    const dtLocal = e.datetime?(()=>{const d=new Date(e.datetime);d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,16);})():'';
    const pOpts = ['„Ç¶„Ç©„ÉÉ„Ç∑„É•„Éâ','„Éä„ÉÅ„É•„É©„É´','„Éè„Éã„Éº / „Éë„É´„Éó„Éâ„Éä„ÉÅ„É•„É©„É´','„Ç¢„Éä„Ç®„É≠„Éì„ÉÉ„ÇØ','„Ç¶„Çß„ÉÉ„Éà„Éè„É´','„Åù„ÅÆ‰ªñ'];
    const rOpts = ['„É©„Ç§„Éà','„Ç∑„Éä„É¢„É≥','„Éü„Éá„Ç£„Ç¢„É†','„Éè„Ç§','„Ç∑„ÉÜ„Ç£','„Éï„É´„Ç∑„ÉÜ„Ç£','„Éï„É¨„É≥„ÉÅ','„Ç§„Çø„É™„Ç¢„É≥'];
    const editFlavHtml = Object.entries(FLAVORS).map(([cat,items])=>`
      <div class="flavor-cat-label">${cat}</div>
      <div class="flavor-chips">${items.map(f=>`<button type="button" class="flavor-chip${flavors.includes(f)?' selected':''}" data-f="${escAttr(f)}" data-cid="ef-${e.id}">${escHTML(f)}</button>`).join('')}</div>
    `).join('');
    setTimeout(()=>{
      document.getElementById('ef-'+e.id)?.querySelectorAll('.flavor-chip').forEach(btn=>{
        btn.addEventListener('click',()=>{ const f=btn.dataset.f; window._editFlavors.has(f)?window._editFlavors.delete(f):window._editFlavors.add(f); btn.classList.toggle('selected',window._editFlavors.has(f)); });
      });
      if(window._editImages&&window._editImages.length) renderImagePreview('ei-preview-'+e.id, window._editImages, false, e.id);
    },0);
    return `
    <div class="entry" id="entry-${e.id}">
      <div class="bullet">${icon}</div>
      <div class="entry-body" style="padding-right:0">
        <div class="edit-form">
          <div class="form-row">
            <div class="form-group"><label>„Ç≥„Éº„Éí„ÉºÂêç</label><input type="text" id="ee-name-${e.id}" value="${escAttr(e.name)}"></div>
            <div class="form-group"><label>Ê∏©Â∫¶</label>
              <div class="toggle-row">
                <button type="button" class="toggle-btn ${e.temp==='hot'?'active':''}" data-etid="${e.id}" data-tv="hot" onclick="this.classList.add('active');this.nextElementSibling.classList.remove('active')">‚òï „Éõ„ÉÉ„Éà</button>
                <button type="button" class="toggle-btn ${e.temp==='iced'?'active':''}" data-etid="${e.id}" data-tv="iced" onclick="this.classList.add('active');this.previousElementSibling.classList.remove('active')">üßä „Ç¢„Ç§„Çπ</button>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>È£≤„Çì„Å†Êó•ÊôÇ</label><input type="datetime-local" id="ee-dt-${e.id}" value="${dtLocal}"></div>
            <div class="form-group"><label>Â†¥ÊâÄ</label><input type="text" id="ee-place-${e.id}" value="${escAttr(e.place||'')}"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>ÂìÅÁ®Æ</label>
              <select id="ee-variety-${e.id}"><option value="">‚Äî</option><option>„Ç≤„Ç§„Ç∑„É£</option><option>„Éñ„É´„Éú„É≥</option><option>„ÉÜ„Ç£„Éî„Ç´</option><option>„Ç´„Éà„Ç•„Éº„É©</option><option>„Ç´„Éà„Ç•„Ç¢„Ç§</option><option>„Éë„Ç´„Éû„É©</option><option>SL28</option><option>SL34</option><option>„É†„É≥„Éâ„Éé„Éº„Éú</option><option>„Éû„É©„Ç¥„Ç∏„ÉÉ„Éö</option><option>„Ç∏„É£„Éê</option><option>„Ç±„É≥„Éà</option><option>S795</option><option>„É≠„Éº„É™„Éä</option><option>„Éì„Ç∏„É£„Çµ„É´„ÉÅ</option><option>„Éè„É©„Éº</option><option>„Ç∏„É≥„Éû</option><option>74110</option><option>74112</option><option>„É´„Ç§„É´11</option><option>„Éê„ÉÜ„Ç£„Ç¢„É≥</option><option>„Ç≥„É≠„É≥„Éì„Ç¢</option><option>„ÇØ„É™„Ç™„Éº„Ç∏„Éß</option><option>„Åù„ÅÆ‰ªñ</option></select>
            </div>
            <div class="form-group"><label>„Éó„É≠„Çª„Çπ</label>
              <select id="ee-process-${e.id}"><option value="">‚Äî</option>${pOpts.map(p=>`<option ${e.process===p?'selected':''}>${p}</option>`).join('')}</select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>ÁÑôÁÖéÂ∫¶</label>
              <select id="ee-rl-${e.id}"><option value="">‚Äî</option>${rOpts.map(r=>`<option ${e.roastLevel===r?'selected':''}>${r}</option>`).join('')}</select>
            </div>
            <div class="form-group"><label>ÁÑôÁÖéÊó•</label><input type="date" id="ee-rd-${e.id}" value="${e.roastDate||''}"></div>
          </div>
          <div style="margin-bottom:12px"><label style="display:block;margin-bottom:8px;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);">„Éï„É¨„Éº„Éê„Éº„Éé„Éº„Éà</label><div id="ef-${e.id}">${editFlavHtml}</div></div>
          <div class="form-group" style="margin-bottom:11px"><label>Ë©ï‰æ°</label>
            <div class="stars-row">${[1,2,3,4,5].map(v=>`<span class="star ${e.rating>=v?'active':''}" data-esid="${e.id}" data-sv="${v}">‚òÖ</span>`).join('')}</div>
          </div>
          <div class="form-group" style="margin-bottom:12px"><label>„É°„É¢</label><textarea id="ee-note-${e.id}">${escHTML(e.note||'')}</textarea></div>
          <div class="form-group" style="margin-bottom:14px">
            <label>ÂÜôÁúü</label>
            <div class="img-upload-area" style="margin-top:5px;">
              <input type="file" accept="image/*" multiple onchange="handleEditImageSelect(event,'${e.id}')">
              <div class="img-upload-label">üì∑ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ËøΩÂä†</div>
            </div>
            <div class="img-preview-row" id="ei-preview-${e.id}"></div>
          </div>
          <div class="form-actions">
            <button class="add-btn" onclick="saveEdit('${e.id}')">‰øùÂ≠ò</button>
            <button class="cancel-btn" onclick="cancelEdit()">„Ç≠„É£„É≥„Çª„É´</button>
          </div>
        </div>
      </div>
    </div>`;
  }

  return `
  <div class="entry" id="entry-${e.id}">
    <div class="bullet">${icon}</div>
    <div class="entry-body">
      <div class="entry-top">
        <span class="entry-name">${escHTML(e.name)}</span>
        <span class="entry-time">${timeStr}</span>
      </div>
      <div class="entry-meta">
        <span class="tag temp-tag">${e.temp==='iced'?'„Ç¢„Ç§„Çπ':'„Éõ„ÉÉ„Éà'}</span>
        ${e.variety?`<span class="tag variety">üåø ${escHTML(e.variety)}</span>`:''}
        ${e.place?`<span class="tag">üìç ${escHTML(e.place)}</span>`:''}
        ${e.process?`<span class="tag process">${escHTML(e.process)}</span>`:''}
        ${e.roastLevel?`<span class="tag roast-tag" data-roast="${escHTML(e.roastLevel)}">${escHTML(e.roastLevel)}</span>`:''}
        ${e.rating?`<span class="entry-rating">${'‚òÖ'.repeat(e.rating)}${'‚òÜ'.repeat(5-e.rating)}</span>`:''}
      </div>
      ${flavors.length?`<div class="entry-meta">${flavors.map(f=>`<span class="tag flavor">üçÉ ${escHTML(f)}</span>`).join('')}</div>`:''}
      ${roastDays!==null?`<div class="entry-detail">ÁÑôÁÖé: <span>${e.roastDate}Ôºà${roastDays}Êó•ÂâçÔºâ</span></div>`:''}
      ${e.altitude?`<div class="entry-detail">Ê®ôÈ´ò: <span>${e.altitude} masl</span></div>`:''}
      ${e.note?`<div class="entry-note">${escHTML(e.note)}</div>`:''}
      ${(e.images&&e.images.length)?`<div class="entry-images">${e.images.map((src,i)=>`<img class="entry-img" src="${src}" onclick="openLightbox(${JSON.stringify(e.images)},${i})">`).join('')}</div>`:''}
    </div>
    <div class="entry-actions">
      <button class="icon-btn share" onclick="openShareModal('${e.id}')" title="\u5171\u6709">&#x1F4E4;</button>
      <button class="icon-btn" onclick="startEdit('${e.id}')" title="\u7de8\u96c6">‚úé</button>
      <button class="icon-btn del" onclick="deleteEntry('${e.id}')" title="\u524a\u9664">‚úï</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: ARCHIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let archiveFilter = 'all'; // 'all' | 'hot' | 'iced'

function setArchiveFilter(f) {
  archiveFilter = (archiveFilter === f && f !== 'all') ? 'all' : f;
  renderArchive();
}

function changeMonth(delta) {
  archiveMonth.m += delta;
  if (archiveMonth.m > 11) { archiveMonth.m=0; archiveMonth.y++; }
  if (archiveMonth.m < 0) { archiveMonth.m=11; archiveMonth.y--; }
  renderArchive();
}

// „Ç´„É¨„É≥„ÉÄ„Éº„Éî„ÉÉ„Ç´„ÉºÁî®Âπ¥Â§âÊï∞
let pickerYear = new Date().getFullYear();

function toggleMonthPicker() {
  const picker = document.getElementById('monthPicker');
  const display = document.getElementById('monthDisplay');
  const isOpen = picker.classList.contains('open');
  if (isOpen) {
    picker.classList.remove('open');
    display.classList.remove('open');
  } else {
    pickerYear = archiveMonth.y;
    renderPickerGrid();
    picker.classList.add('open');
    display.classList.add('open');
  }
}

function closeMonthPicker() {
  document.getElementById('monthPicker').classList.remove('open');
  document.getElementById('monthDisplay').classList.remove('open');
}

function pickerChangeYear(delta) {
  const now = new Date();
  const newYear = pickerYear + delta;
  if (newYear < 2020 || newYear > now.getFullYear()) return;
  pickerYear = newYear;
  renderPickerGrid();
}

function renderPickerGrid() {
  const now = new Date();
  document.getElementById('pickerYear').textContent = pickerYear + 'Âπ¥';
  const months = ['1Êúà','2Êúà','3Êúà','4Êúà','5Êúà','6Êúà','7Êúà','8Êúà','9Êúà','10Êúà','11Êúà','12Êúà'];
  const grid = document.getElementById('pickerGrid');
  grid.innerHTML = months.map((label, i) => {
    const isFuture = pickerYear > now.getFullYear() || (pickerYear === now.getFullYear() && i > now.getMonth());
    const isSelected = pickerYear === archiveMonth.y && i === archiveMonth.m;
    const isCurrentMonth = pickerYear === now.getFullYear() && i === now.getMonth();
    const prefix = `${pickerYear}-${String(i+1).padStart(2,'0')}`;
    const count = entries.filter(e => (e.datetime||'').startsWith(prefix)).length;
    const hasEntries = count > 0;
    let cls = 'month-picker-cell';
    if (isFuture) cls += ' future';
    if (isSelected) cls += ' selected';
    if (isCurrentMonth && !isSelected) cls += ' current-month';
    if (hasEntries && !isSelected) cls += ' has-entries';
    const dataCount = hasEntries ? ` data-count="${count}"` : '';
    return `<div class="${cls}"${dataCount} onclick="selectPickerMonth(${pickerYear},${i})">${label}</div>`;
  }).join('');
}

function selectPickerMonth(y, m) {
  archiveMonth.y = y;
  archiveMonth.m = m;
  closeMonthPicker();
  renderArchive();
}

// „Éî„ÉÉ„Ç´„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
document.addEventListener('click', (e) => {
  const nav = document.getElementById('monthNav');
  if (nav && !nav.contains(e.target)) closeMonthPicker();
});

function renderMonthlyLog(y, m, mEntries) {
  const grid = document.getElementById('monthlyLogGrid');
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const firstDow = new Date(y, m, 1).getDay(); // 0=Sun
  const todayStr = new Date().toISOString().slice(0,10);

  // Êó•Âà•„Éû„ÉÉ„ÉóÔºàYYYY-MM-DD ‚Üí {hot, iced}Ôºâ
  const dayMap = {};
  mEntries.forEach(e => {
    const d = (e.datetime||'').split('T')[0];
    if (!d) return;
    if (!dayMap[d]) dayMap[d] = {hot:0, iced:0};
    if (e.temp === 'iced') dayMap[d].iced++;
    else dayMap[d].hot++;
  });

  const dows = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
  let html = dows.map((d,i) =>
    `<div class="mlg-dow${i===0?' sun':i===6?' sat':''}">${d}</div>`
  ).join('');

  // Á©∫ÁôΩ„Çª„É´ÔºàÊúà„ÅÆÂÖàÈ†≠ÊõúÊó•ÂàÜÔºâ
  for (let i = 0; i < firstDow; i++) {
    html += '<div class="mlg-cell empty"></div>';
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow = new Date(y, m, d).getDay();
    const info = dayMap[dateStr];
    const total = info ? info.hot + info.iced : 0;
    const isToday = dateStr === todayStr;
    const hasSun = dow === 0;
    const hasSat = dow === 6;

    let classes = 'mlg-cell';
    if (info) classes += ' has-entry';
    if (isToday) classes += ' today';
    if (hasSun) classes += ' sun';
    if (hasSat) classes += ' sat';

    let dotsHtml = '';
    if (info) {
      // „Éõ„ÉÉ„Éà„Éâ„ÉÉ„ÉàÔºàÊúÄÂ§ß4ÂÄãÔºâ
      const hotDots = Math.min(info.hot, 4);
      const icedDots = Math.min(info.iced, 4 - hotDots);
      const dots = Array(hotDots).fill('<span class="mlg-dot hot"></span>')
        .concat(Array(icedDots).fill('<span class="mlg-dot iced"></span>'));
      dotsHtml = `<div class="mlg-dots">${dots.join('')}</div>`;
      if (total > 4) dotsHtml += `<div class="mlg-count">${total}</div>`;
    }

    const onclick = info ? `onclick="scrollToDate('${dateStr}')"` : '';
    html += `<div class="${classes}" ${onclick} title="${dateStr}${info?' ('+total+'ÊùØ)':''}">
      <div class="mlg-date">${d}</div>
      ${dotsHtml}
    </div>`;
  }

  grid.innerHTML = html;
}

function scrollToDate(dateStr) {
  // „Éï„Ç£„É´„Çø„Éº„ÇíÂÖ®‰ª∂„Å´Êàª„Åô
  if (archiveFilter !== 'all') setArchiveFilter('all');
  // Ë©≤ÂΩìÊó•‰ªò„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÊé¢„Åô
  setTimeout(() => {
    const groups = document.querySelectorAll('#archive-list .date-group');
    for (const g of groups) {
      const label = g.querySelector('.date-label');
      if (label && g.dataset.date === dateStr) {
        g.scrollIntoView({behavior:'smooth', block:'start'});
        g.style.background = 'rgba(5,45,87,0.04)';
        setTimeout(() => g.style.background = '', 1200);
        return;
      }
    }
  }, 50);
}

function renderArchive() {
  const {y,m} = archiveMonth;
  document.getElementById('monthDisplayText').textContent = `${y}Âπ¥ ${m+1}Êúà`;
  const prefix = `${y}-${String(m+1).padStart(2,'0')}`;
  const mEntries = entries.filter(e=>(e.datetime||'').startsWith(prefix));
  // „Éû„É≥„Çπ„É™„Éº„É≠„Ç∞„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÊèèÁîª
  renderMonthlyLog(y, m, mEntries);
  document.getElementById('ms-total').textContent = mEntries.length;
  document.getElementById('ms-hot').textContent = mEntries.filter(e=>e.temp==='hot').length;
  document.getElementById('ms-iced').textContent = mEntries.filter(e=>e.temp==='iced').length;
  const rated = mEntries.filter(e=>e.rating>0);
  document.getElementById('ms-avg').textContent = rated.length ? (rated.reduce((s,e)=>s+e.rating,0)/rated.length).toFixed(1) : '‚Äî';
  // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÊõ¥Êñ∞
  ['all','hot','iced'].forEach(key => {
    const el = document.getElementById('af-'+key);
    if (el) el.classList.toggle('af-active', archiveFilter === key);
  });
  // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
  let displayEntries = mEntries;
  if (archiveFilter === 'hot') displayEntries = mEntries.filter(e=>e.temp==='hot');
  else if (archiveFilter === 'iced') displayEntries = mEntries.filter(e=>e.temp==='iced');
  const flavorCount = {};
  mEntries.forEach(e=>(e.flavors||[]).forEach(f=>{ flavorCount[f]=(flavorCount[f]||0)+1; }));
  const topFlavors = Object.entries(flavorCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const flavorBar = document.getElementById('monthFlavorBar');
  if (topFlavors.length>0) {
    flavorBar.style.display='block';
    const max = topFlavors[0][1];
    document.getElementById('monthFlavorBars').innerHTML = topFlavors.map(([f,c])=>`
      <div class="flavor-bar-row">
        <span class="flavor-bar-label">${escHTML(f)}</span>
        <div class="flavor-bar-track"><div class="flavor-bar-fill" style="width:${Math.round(c/max*100)}%"></div></div>
        <span class="flavor-bar-count">${c}</span>
      </div>`).join('');
  } else { flavorBar.style.display='none'; }
  const archList = document.getElementById('archive-list');
  if (displayEntries.length===0) {
    const msg = archiveFilter !== 'all'
      ? `<div class="empty"><div class="empty-icon">${archiveFilter==='hot'?'‚òï':'üß£'}</div>Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`
      : `<div class="empty"><div class="empty-icon">üìÖ</div>„Åì„ÅÆÊúà„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
    archList.innerHTML = msg; return;
  }
  const groups = {};
  displayEntries.forEach(e=>{const d=(e.datetime||'').split('T')[0];(groups[d]=groups[d]||[]).push(e);});
  archList.innerHTML = Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(date=>{
    const label = formatDate(new Date(date+'T12:00:00'));
    const items = groups[date].map(e=>`
      <div class="month-entry-row entry" onclick="openEntryDetail('${e.id}')">
        <div class="bullet">${e.temp==='iced'?'üßä':'‚òï'}</div>
        <div class="entry-body" style="padding-right:48px">
          <div class="entry-top">
            <span class="entry-name">${escHTML(e.name)}</span>
            <span class="entry-time">${e.datetime?formatTime(new Date(e.datetime)):''}</span>
          </div>
          <div class="entry-meta">
            ${e.variety?`<span class="tag variety">üåø ${escHTML(e.variety)}</span>`:''}
            ${e.place?`<span class="tag">üìç ${escHTML(e.place)}</span>`:''}
            ${e.process?`<span class="tag process">${escHTML(e.process)}</span>`:''}
            ${e.roastLevel?`<span class="tag roast-tag" data-roast="${escHTML(e.roastLevel)}">${escHTML(e.roastLevel)}</span>`:''}
            ${e.rating?`<span class="entry-rating">${'‚òÖ'.repeat(e.rating)}${'‚òÜ'.repeat(5-e.rating)}</span>`:''}
          </div>
          ${(e.flavors||[]).length?`<div class="entry-meta">${e.flavors.slice(0,4).map(f=>`<span class="tag flavor">üçÉ ${escHTML(f)}</span>`).join('')}${e.flavors.length>4?`<span class="tag flavor">+${e.flavors.length-4}</span>`:''}</div>`:''}
          ${e.note?`<div class="entry-note">${escHTML(e.note)}</div>`:''}
        </div>
        <div class="entry-actions">
          <button class="icon-btn del" onclick="event.stopPropagation();deleteEntry('${e.id}').then(()=>renderArchive())" title="ÂâäÈô§">‚úï</button>
        </div>
      </div>`).join('');
    return `<div class="date-group" data-date="${date}"><div class="date-label"><span>${label}</span></div>${items}</div>`;
  }).join('');
}

function openEntryDetail(id) {
  const e = entries.find(x => x.id === id);
  if (!e) return;
  const icon = e.temp === 'iced' ? 'üßä' : '‚òï';
  const roastDays = e.roastDate ? Math.floor((new Date()-new Date(e.roastDate+'T12:00:00'))/86400000) : null;
  const flavors = e.flavors || [];
  // „Éò„ÉÉ„ÉÄ„Éº
  document.getElementById('ed-icon').textContent = icon;
  document.getElementById('ed-name').textContent = e.name;
  const timeStr = e.datetime ? formatDate(new Date(e.datetime.split('T')[0]+'T12:00:00')) + ' ' + formatTime(new Date(e.datetime)) : '';
  document.getElementById('ed-time').textContent = timeStr;
  // „Çø„Ç∞
  document.getElementById('ed-tags').innerHTML = [
    `<span class="tag temp-tag">${e.temp==='iced'?'„Ç¢„Ç§„Çπ':'„Éõ„ÉÉ„Éà'}</span>`,
    e.variety ? `<span class="tag variety">üåø ${escHTML(e.variety)}</span>` : '',
    e.place ? `<span class="tag">üìç ${escHTML(e.place)}</span>` : '',
    e.process ? `<span class="tag process">${escHTML(e.process)}</span>` : '',
    e.roastLevel ? `<span class="tag roast-tag" data-roast="${escHTML(e.roastLevel)}">${escHTML(e.roastLevel)}</span>` : '',
    e.rating ? `<span class="entry-rating">${'‚òÖ'.repeat(e.rating)}${'‚òÜ'.repeat(5-e.rating)}</span>` : '',
  ].join('');
  // „Éï„É¨„Éº„Éê„Éº
  const flavWrap = document.getElementById('ed-flavors-wrap');
  if (flavors.length) {
    flavWrap.style.display = 'block';
    document.getElementById('ed-flavors').innerHTML = flavors.map(f=>`<span class="tag flavor">üçÉ ${escHTML(f)}</span>`).join('');
  } else { flavWrap.style.display = 'none'; }
  // ÁÑôÁÖéÊó•
  const roastWrap = document.getElementById('ed-roast-wrap');
  if (roastDays !== null) {
    roastWrap.style.display = 'block';
    document.getElementById('ed-roast').innerHTML = `ÁÑôÁÖéÊó•: <span>${e.roastDate}Ôºà${roastDays}Êó•ÂâçÔºâ</span>`;
  } else { roastWrap.style.display = 'none'; }
  // Ê®ôÈ´ò
  const altWrap = document.getElementById('ed-altitude-wrap');
  if (e.altitude) {
    altWrap.style.display = 'block';
    document.getElementById('ed-altitude').innerHTML = `Ê®ôÈ´ò: <span>${escHTML(e.altitude)} masl</span>`;
  } else { altWrap.style.display = 'none'; }
  // „É°„É¢
  const noteWrap = document.getElementById('ed-note-wrap');
  if (e.note) {
    noteWrap.style.display = 'block';
    document.getElementById('ed-note').textContent = e.note;
  } else { noteWrap.style.display = 'none'; }
  // ÁîªÂÉè
  const imagesWrap = document.getElementById('ed-images-wrap');
  if (e.images && e.images.length) {
    imagesWrap.style.display = 'block';
    document.getElementById('ed-images').innerHTML = e.images.map((src,i)=>
      `<img class="entry-detail-img" src="${src}" onclick="openLightbox(${JSON.stringify(e.images)},${i})" alt="">`
    ).join('');
  } else { imagesWrap.style.display = 'none'; }
  // Ë±ÜÊÉÖÂ†±
  const beanWrap = document.getElementById('ed-bean-wrap');
  const bean = e.beanId ? beans.find(b => b.id === e.beanId) : null;
  if (bean) {
    beanWrap.style.display = 'block';
    document.getElementById('ed-bean-btn').innerHTML = `üå± Ë±Ü„ÅÆË©≥Á¥∞: <strong>${escHTML(bean.name)}</strong>${bean.variety?' ‚Äî '+escHTML(bean.variety):''}  ‚Ä∫`;
    document.getElementById('ed-bean-btn').onclick = () => { closeEntryDetail(); openBeanDetail(bean.id); };
  } else { beanWrap.style.display = 'none'; }
  // „Éú„Çø„É≥
  document.getElementById('ed-share-btn').onclick = () => { closeEntryDetail(); openShareModal(id); };
  document.getElementById('ed-edit-btn').onclick = () => { closeEntryDetail(); showPage('journal'); setTimeout(()=>startEdit(id),100); };
  document.getElementById('ed-del-btn').onclick = () => { closeEntryDetail(); deleteEntry(id).then(()=>renderArchive()); };
  // Ë°®Á§∫
  document.getElementById('entryDetailModal').classList.remove('hidden');
}

function closeEntryDetail() {
  document.getElementById('entryDetailModal').classList.add('hidden');
}

function goToEntry(id) {
  showPage('journal');
  setTimeout(()=>{ const el=document.getElementById('entry-'+id); if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='var(--navy-05)';setTimeout(()=>{el.style.background='';},1200);} },100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: BEANS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBeanSelect() {
  const sel = document.getElementById('f-bean-ref');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Ë±Ü„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÈÅ∏Êäû ‚Äî</option>'+beans.map(b=>`<option value="${b.id}" ${b.id===cur?'selected':''}>${escHTML(b.name)}${b.variety?' ('+escHTML(b.variety)+')':''}</option>`).join('');
}

function renderBeans() {
  const grid = document.getElementById('beanGrid');
  document.getElementById('bean-count').textContent = beans.length+' Á®Æ';
  const cards = beans.map(b => {
    const usedCount = entries.filter(e=>e.beanId===b.id).length;
    const roastDays = b.roastDate?Math.floor((new Date()-new Date(b.roastDate+'T12:00:00'))/86400000):null;
    return `
    <div class="bean-card" onclick="openBeanDetail('${b.id}')" style="cursor:pointer;">
      <div class="bean-card-actions">
        <button class="icon-btn" onclick="event.stopPropagation();openBeanModal('${b.id}')" title="Á∑®ÈõÜ">‚úé</button>
        <button class="icon-btn del" onclick="event.stopPropagation();deleteBean('${b.id}')" title="ÂâäÈô§">‚úï</button>
      </div>
      <div class="bean-card-name">${escHTML(b.name)}</div>
      <div class="bean-card-meta">
        ${b.variety?`<span class="tag variety">üåø ${escHTML(b.variety)}</span>`:''}
        ${b.country?`<span class="tag">üåç ${escHTML(b.country)}</span>`:''}
        ${b.process?`<span class="tag process">${escHTML(b.process)}</span>`:''}
        ${b.roastLevel?`<span class="tag roast-tag" data-roast="${escHTML(b.roastLevel)}">${escHTML(b.roastLevel)}</span>`:''}
      </div>
      ${b.region?`<div class="entry-detail" style="margin-bottom:4px">Âú∞Âüü: <span>${escHTML(b.region)}</span></div>`:''}
      ${b.altitude?`<div class="entry-detail" style="margin-bottom:4px">Ê®ôÈ´ò: <span>${escHTML(b.altitude)} masl</span></div>`:''}
      ${b.roaster?`<div class="entry-detail" style="margin-bottom:4px">„É≠„Éº„Çπ„Çø„Éº: <span>${escHTML(b.roaster)}</span></div>`:''}
      ${roastDays!==null?`<div class="entry-detail" style="margin-bottom:4px">ÁÑôÁÖé: <span>${b.roastDate}Ôºà${roastDays}Êó•ÂâçÔºâ</span></div>`:''}
      ${b.note?`<div class="bean-card-note">${escHTML(b.note)}</div>`:''}
      <div class="bean-card-stat">„Åì„ÅÆ„Ç∏„É£„Éº„Éä„É´„Å´Ë®òÈå≤: <span>${usedCount}ÊùØ</span></div>
    </div>`;
  }).join('');
  grid.innerHTML = cards + `<button class="bean-add-btn" onclick="openBeanModal()">Ôºã Êñ∞„Åó„ÅÑË±Ü„ÇíÁôªÈå≤</button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEAN DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: INSIGHTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInsights() {
  if (!entries.length) {
    ['ins-flavors','ins-roasts','ins-ratings','ins-processes','ins-places','ins-beans'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '<div class="insight-empty">Ë®òÈå≤„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    });
    return;
  }

  const total = entries.length;
  const rated = entries.filter(e => e.rating > 0);
  const avgRating = rated.length ? (rated.reduce((s,e) => s + e.rating, 0) / rated.length).toFixed(1) : '‚Äî';
  const dates = entries.map(e => e.datetime ? e.datetime.split('T')[0] : null).filter(Boolean).sort();
  const daySpan = dates.length >= 2 ? Math.floor((new Date(dates[dates.length-1]) - new Date(dates[0])) / 86400000) + 1 : 1;
  const beanIds = new Set(entries.map(e => e.beanId).filter(Boolean));
  const hotCount = entries.filter(e => e.temp === 'hot').length;
  const icedCount = entries.filter(e => e.temp === 'iced').length;

  // „Çµ„Éû„É™„Éº
  document.getElementById('ins-total').textContent = total;
  document.getElementById('ins-avg').textContent = avgRating;
  document.getElementById('ins-days').textContent = daySpan;
  document.getElementById('ins-beans-used').textContent = beanIds.size || '‚Äî';
  const hotPct = total ? (hotCount / total * 100).toFixed(0) : 50;
  const icedPct = 100 - hotPct;
  document.getElementById('ins-hot-bar').style.width = hotPct + '%';
  document.getElementById('ins-iced-bar').style.width = icedPct + '%';
  document.getElementById('ins-hot-label').textContent = `‚òï „Éõ„ÉÉ„Éà ${hotCount} (${hotPct}%)`;
  document.getElementById('ins-iced-label').textContent = `üßä „Ç¢„Ç§„Çπ ${icedCount} (${icedPct}%)`;

  function renderBars(containerId, data, colorFn) {
    const el = document.getElementById(containerId);
    if (!data.length) { el.innerHTML = '<div class="insight-empty">„Éá„Éº„Çø„Å™„Åó</div>'; return; }
    const max = data[0][1];
    el.innerHTML = data.map(([label, count]) => {
      const pct = (count / max * 100).toFixed(0);
      const color = colorFn ? colorFn(label) : 'var(--navy)';
      return `<div class="insight-bar-row">
        <div class="insight-bar-label" title="${escHTML(label)}">${escHTML(label)}</div>
        <div class="insight-bar-track"><div class="insight-bar-fill" style="width:${pct}%;background:${color}"></div></div>
        <div class="insight-bar-count">${count}</div>
      </div>`;
    }).join('');
  }

  // „Éï„É¨„Éº„Éê„Éº Top 10
  const flavorMap = {};
  entries.forEach(e => (e.flavors||[]).forEach(f => { flavorMap[f] = (flavorMap[f]||0) + 1; }));
  const flavorData = Object.entries(flavorMap).sort((a,b) => b[1]-a[1]).slice(0,10);
  renderBars('ins-flavors', flavorData, () => 'var(--navy)');

  // ÁÑôÁÖéÂ∫¶ÂàÜÂ∏É
  const roastOrder = ['„É©„Ç§„Éà','„Ç∑„Éä„É¢„É≥','„Éü„Éá„Ç£„Ç¢„É†','„Éè„Ç§','„Ç∑„ÉÜ„Ç£','„Éï„É´„Ç∑„ÉÜ„Ç£','„Éï„É¨„É≥„ÉÅ','„Ç§„Çø„É™„Ç¢„É≥'];
  const roastColors = {
    '„É©„Ç§„Éà':'#D9F7A2','„Ç∑„Éä„É¢„É≥':'#F6DE8B','„Éü„Éá„Ç£„Ç¢„É†':'#E8C36A',
    '„Éè„Ç§':'#A95522','„Ç∑„ÉÜ„Ç£':'#8B4A2A','„Éï„É´„Ç∑„ÉÜ„Ç£':'#5B2D1A',
    '„Éï„É¨„É≥„ÉÅ':'#3D1A0E','„Ç§„Çø„É™„Ç¢„É≥':'#1E0A05'
  };
  const roastMap = {};
  entries.forEach(e => { if (e.roastLevel) roastMap[e.roastLevel] = (roastMap[e.roastLevel]||0) + 1; });
  const roastData = roastOrder.filter(r => roastMap[r]).map(r => [r, roastMap[r]]);
  const otherRoast = Object.entries(roastMap).filter(([r]) => !roastOrder.includes(r)).sort((a,b) => b[1]-a[1]);
  renderBars('ins-roasts', [...roastData, ...otherRoast], label => roastColors[label] || 'var(--navy)');

  // Ë©ï‰æ°ÂàÜÂ∏É
  const ratingEl = document.getElementById('ins-ratings');
  const ratingMap = {1:0,2:0,3:0,4:0,5:0};
  entries.forEach(e => { if (e.rating) ratingMap[e.rating]++; });
  const maxR = Math.max(...Object.values(ratingMap), 1);
  ratingEl.innerHTML = [5,4,3,2,1].map(r => {
    const pct = (ratingMap[r] / maxR * 100).toFixed(0);
    return `<div class="insight-rating-row">
      <div class="insight-rating-stars">${'‚òÖ'.repeat(r)}${'\u2606'.repeat(5-r)}</div>
      <div class="insight-bar-track" style="flex:1"><div class="insight-bar-fill" style="width:${pct}%;background:var(--yellow)"></div></div>
      <div class="insight-bar-count">${ratingMap[r]}</div>
    </div>`;
  }).join('');

  // „Éó„É≠„Çª„ÇπÂàÜÂ∏É
  const processMap = {};
  entries.forEach(e => { if (e.process) processMap[e.process] = (processMap[e.process]||0) + 1; });
  const processData = Object.entries(processMap).sort((a,b) => b[1]-a[1]);
  const processColors = ['‚ë†','‚ë°','‚ë¢','‚ë£','‚ë§'].map((_,i) => `hsl(${200+i*30},60%,45%)`);
  renderBars('ins-processes', processData, (label) => {
    const idx = processData.findIndex(([l]) => l === label);
    return processColors[idx % processColors.length];
  });

  // Â†¥ÊâÄ„É©„É≥„Ç≠„É≥„Ç∞ Top 8
  const placeMap = {};
  entries.forEach(e => { if (e.place) placeMap[e.place] = (placeMap[e.place]||0) + 1; });
  const placeData = Object.entries(placeMap).sort((a,b) => b[1]-a[1]).slice(0,8);
  renderBars('ins-places', placeData, () => '#4A90D9');

  // „ÅäÊ∞ó„Å´ÂÖ•„ÇäË±Ü Top 5
  const beanCountMap = {};
  entries.forEach(e => { if (e.beanId) beanCountMap[e.beanId] = (beanCountMap[e.beanId]||0) + 1; });
  const beanData = Object.entries(beanCountMap).sort((a,b) => b[1]-a[1]).slice(0,5).map(([id, count]) => {
    const b = beans.find(x => x.id === id);
    return [b ? b.name : '‰∏çÊòé', count];
  });
  renderBars('ins-beans', beanData, () => '#7B5EA7');

  // ÊúàÂà•Êé®Áßª„ÉÅ„É£„Éº„Éà
  const monthMap = {};
  entries.forEach(e => {
    if (!e.datetime) return;
    const ym = e.datetime.slice(0,7);
    monthMap[ym] = (monthMap[ym]||0) + 1;
  });
  const months = Object.keys(monthMap).sort();
  const canvas = document.getElementById('ins-month-chart');
  canvas.width = canvas.parentElement.offsetWidth || 320;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const pad = {top:20, right:16, bottom:30, left:32};
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  const maxVal = Math.max(...Object.values(monthMap), 1);
  ctx.clearRect(0, 0, W, H);
  // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
  ctx.strokeStyle = 'rgba(5,45,87,0.08)';
  ctx.lineWidth = 1;
  [0.25,0.5,0.75,1].forEach(r => {
    const y = pad.top + chartH * (1 - r);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + chartW, y); ctx.stroke();
    ctx.fillStyle = 'rgba(5,45,87,0.35)'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxVal * r), pad.left - 4, y + 4);
  });
  if (months.length < 2) {
    ctx.fillStyle = 'rgba(5,45,87,0.4)'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('Ë®òÈå≤„Åå2„É∂Êúà‰ª•‰∏ä„Å´„Å™„Çã„Å®Êé®Áßª„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô', W/2, H/2);
    return;
  }
  // Â°ó„Çä„Å§„Å∂„Åó„Ç®„É™„Ç¢
  const pts = months.map((m, i) => ({
    x: pad.left + (i / (months.length - 1)) * chartW,
    y: pad.top + chartH * (1 - monthMap[m] / maxVal)
  }));
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, pad.top + chartH);
  ctx.lineTo(pts[0].x, pad.top + chartH);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
  grad.addColorStop(0, 'rgba(5,45,87,0.25)');
  grad.addColorStop(1, 'rgba(5,45,87,0.02)');
  ctx.fillStyle = grad;
  ctx.fill();
  // Êäò„ÇåÁ∑ö
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = 'var(--navy)'; ctx.lineWidth = 2; ctx.stroke();
  // ÁÇπ
  pts.forEach((p, i) => {
    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
    ctx.fillStyle = 'var(--navy)'; ctx.fill();
    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
  });
  // XËª∏„É©„Éô„É´
  ctx.fillStyle = 'rgba(5,45,87,0.45)'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
  const step = Math.max(1, Math.ceil(months.length / 6));
  months.forEach((m, i) => {
    if (i % step !== 0 && i !== months.length - 1) return;
    const p = pts[i];
    ctx.fillText(m.slice(2).replace('-','/'), p.x, pad.top + chartH + 18);
  });
}

function openBeanDetail(id) {
  const b = beans.find(x => x.id === id);
  if (!b) return;
  const usedCount = entries.filter(e => e.beanId === b.id).length;
  const roastDays = b.roastDate ? Math.floor((new Date()-new Date(b.roastDate+'T12:00:00'))/86400000) : null;
  // ÂêçÂâç
  document.getElementById('bd-name').textContent = b.name;
  // „Çø„Ç∞
  const tagsEl = document.getElementById('bd-tags');
  tagsEl.innerHTML = [
    b.variety ? `<span class="tag variety">üåø ${escHTML(b.variety)}</span>` : '',
    b.country ? `<span class="tag">üåç ${escHTML(b.country)}</span>` : '',
    b.process ? `<span class="tag process">${escHTML(b.process)}</span>` : '',
    b.roastLevel ? `<span class="tag roast-tag" data-roast="${escHTML(b.roastLevel)}">${escHTML(b.roastLevel)}</span>` : '',
  ].join('');
  // Ë©≥Á¥∞ÊÉÖÂ†±„Ç∞„É™„ÉÉ„Éâ
  const infoItems = [
    { key: 'Âú∞Âüü / Ëæ≤Âúí', val: b.region },
    { key: 'Ê®ôÈ´ò', val: b.altitude ? b.altitude+' masl' : null },
    { key: '„É≠„Éº„Çπ„Çø„Éº', val: b.roaster },
    { key: 'ÁÑôÁÖéÊó•', val: roastDays !== null ? `${b.roastDate}Ôºà${roastDays}Êó•ÂâçÔºâ` : b.roastDate || null },
  ].filter(x => x.val);
  document.getElementById('bd-info').innerHTML = infoItems.map(x =>
    `<div class="bean-detail-info-item"><span class="bean-detail-info-key">${x.key}</span><span class="bean-detail-info-val">${escHTML(x.val)}</span></div>`
  ).join('');
  // „É°„É¢
  const noteWrap = document.getElementById('bd-note-wrap');
  if (b.note) {
    noteWrap.style.display = 'block';
    document.getElementById('bd-note').textContent = b.note;
  } else { noteWrap.style.display = 'none'; }
  // ÁîªÂÉè
  const imagesWrap = document.getElementById('bd-images-wrap');
  const imagesEl = document.getElementById('bd-images');
  if (b.images && b.images.length) {
    imagesWrap.style.display = 'block';
    imagesEl.innerHTML = b.images.map((src, i) =>
      `<img class="bean-detail-img" src="${src}" onclick="openLightbox(${JSON.stringify(b.images)},${i})" alt="">`
    ).join('');
  } else { imagesWrap.style.display = 'none'; }
  // ‰ΩøÁî®Áµ±Ë®à
  document.getElementById('bd-stat').innerHTML = `„Åì„ÅÆ„Ç∏„É£„Éº„Éä„É´„Å´Ë®òÈå≤: <span>${usedCount}ÊùØ</span>`;
  // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö
  document.getElementById('bd-edit-btn').onclick = () => { closeBeanDetail(); openBeanModal(id); };
  document.getElementById('bd-del-btn').onclick = () => { closeBeanDetail(); deleteBean(id); };
  // Ë°®Á§∫
  document.getElementById('beanDetailModal').classList.remove('hidden');
}

function closeBeanDetail() {
  document.getElementById('beanDetailModal').classList.add('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL: BEAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('beanModal').addEventListener('click', e => { if(e.target.id==='beanModal') closeBeanModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatDate(d){const days=['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];return `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà${d.getDate()}Êó•Ôºà${days[d.getDay()]}Ôºâ`;}
function formatTime(d){return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
function escHTML(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escAttr(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  document.getElementById('f-datetime').value = now.toISOString().slice(0,16);
  buildFlavorUI('flavorCategories');
  setupStars('stars', ()=>rating, v=>{ rating=v; });
  setupImageDrop('f-img-area','f-img-preview');
}

init();
startup();

</script>
</body>
</html>
